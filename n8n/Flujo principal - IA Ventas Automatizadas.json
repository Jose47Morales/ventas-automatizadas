{
  "name": "Flujo principal - IA Ventas Automatizadas",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-incoming",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3952,
        6304
      ],
      "id": "681a4e54-ecfa-4d99-9f48-fc54631df1ae",
      "name": "Webhook",
      "webhookId": "41022456-de2c-4715-9b85-08e5089bec5c"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Tomamos el body completo\nconst body = $input.item.json.body;\n\n// Validamos que venga el raw\nif (!body || !body.raw) {\n  return { json: { isMessage: false, type: \"no_raw_data\" } };\n}\n\nconst messages = body.raw.messages;\nconst contacts = body.raw.contacts;\n\n// Si no existen mensajes, no es un mensaje de usuario\nif (!messages || messages.length === 0) {\n  return { json: { isMessage: false, type: \"status_update\" } };\n}\n\n// Tomamos el mensaje real\nconst msg = messages[0];\nconst contact = contacts?.[0];\n\n// Extraemos campos importantes\nconst messageId = msg.id || \"\";\nconst from = msg.from || \"\";\nconst timestamp = msg.timestamp || Date.now();\nconst messageType = msg.type || \"unknown\";\nconst userName = contact?.profile?.name || null;\nlet messageText = \"\";\n\n// Si es texto\nif (messageType === \"text\") {\n  messageText = msg.text?.body || \"\";\n}\n\n// Retornamos la estructura lista para el flujo\nreturn {\n  json: {\n    from,\n    userName,\n    messageId,\n    messageType,\n    messageText,\n    timestamp,\n    isMessage: true,\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3760,
        6304
      ],
      "id": "8f0fcbbf-6500-41ba-81cb-75bc3b7986de",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "06d8d6f4-ada9-42f0-bdd8-e0f3d4108df6",
              "leftValue": "={{ $json.isMessage }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3504,
        6304
      ],
      "id": "baa525a0-3395-4aa8-8f9f-cdb2ab78d526",
      "name": "¬øEs mensaje v√°lido?"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "13af32a3-5623-42ab-b84e-5fe0a7e59175",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "awaiting.quantity",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Esperando cantidad"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "2d63d588-0ee6-4d7e-91d8-03783c1c8aa6",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "awaiting.confirmation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Esperando confirmaci√≥n"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "453d9267-e9c2-4a39-892e-6d7d76df0e1a",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "awaiting.payment",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Esperando pago"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8490297e-0795-4ea1-aa64-888975ca8b5f",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "awaiting.selection",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Seleccionando producto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "explorar_productos",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "e9f6d192-1784-4bd7-a4ba-a39dbeac889b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Explorar productos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9cbd4274-9bdd-4d8f-807a-f86bc55ccfcc",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "soporte",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Soporte"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8e8c9cae-d1ee-4a42-8073-f377ab6fffdb",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "saludo",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Saludo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a53b5412-7e2c-4a8a-b1d5-8cb33283bca3",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "estado_pedido",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Estado Pedido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c7a0208b-81e2-40fa-8a02-9ee4e111b7b3",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "despedida",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Despedida"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9c9b4f27-47e5-47e3-8a01-e21ddf40dc99",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "seleccion_invalida",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Selecci√≥n invalida"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "aefd64ec-db0c-4aad-8412-239f2a3d188a",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "cambiar_detal",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cambiar DETAL"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "42a2ec87-b00d-4794-a60a-1b6f4b2ea009",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "awaiting.delivery_address",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Esperando Direcci√≥n"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b264111a-8b4c-4737-8356-372e84219c27",
                    "leftValue": "={{ ($json.sessionState && $json.sessionState !== 'idle' && $json.sessionState !== 'awaiting.product') ? $json.sessionState : $json.intencion }}",
                    "rightValue": "awaiting.delivery_address_confirmation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Esperando Confirmaci√≥n Direcci√≥n"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -1824,
        5904
      ],
      "id": "55ea85c2-52cd-4fa8-bb57-4e1ad7c487c1",
      "name": "Rutear por intenci√≥n"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7295eb3-2c61-4ddc-a52c-165cab6b4161",
              "name": "message",
              "value": "=Hola {{ $json.name }}, lamento que tengas un inconveniente. üîß\n\nNuestro equipo de soporte est√° aqu√≠ para ayudarte.            \n\nPor favor describe tu situaci√≥n con el mayor detalle posible:            \n\n‚Ä¢ ¬øQu√© producto o servicio tiene el problema?      \n‚Ä¢ ¬øQu√© error est√°s experimentando?\n‚Ä¢ ¬øCu√°ndo comenz√≥ el problema?            \n\nUn agente te atender√° lo antes posible.      \n\n‚è±Ô∏è Tiempo estimado: 5-10 minutos",
              "type": "string"
            },
            {
              "id": "19b04029-2356-4eca-aa11-24eb8ee4a5fb",
              "name": "from",
              "value": "={{ $json.from }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1056,
        5520
      ],
      "id": "3b972330-3831-47db-a036-9e08246dd37c",
      "name": "Soporte"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "48033d53-0ed9-4ade-ad9f-fde939249209",
              "name": "message",
              "value": "=¬°Hola {{ $json.name }}! üëã\n\n¬°Qu√© gusto saludarte! \nSoy tu asistente virtual y estoy aqu√≠ para ayudarte. üòä\n\n¬øEn qu√© puedo ayudarte hoy?\n\nüíº Ver productos y servicios      \nüõí Realizar una compra      \nüîß Soporte t√©cnico      \nüë§ Hablar con un agente humano\n\nSolo escribe lo que necesitas y te ayudo de inmediato.",
              "type": "string"
            },
            {
              "id": "a0bd9c8a-b7e7-41d8-8137-bd7735ed2818",
              "name": "from",
              "value": "={{ $json.from }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1072,
        6080
      ],
      "id": "800fc26d-6d60-426a-82d0-595864b3fff0",
      "name": "Saludo"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "033217ee-e17a-460f-994c-4aab2865b55a",
              "name": "message",
              "value": "=Hola {{ $json.userName }}, gracias por tu mensaje. üòä\n\nNo estoy seguro de c√≥mo ayudarte con eso en este momento, pero puedo asistirte con:\n\nüì¶ Ver productos y servcios      \nüõí Realizar compras      \nüîß Soporte t√©cnico      \nüí¨ Consultas generales\n\n¬øHay algo espec√≠fico en lo que pueda ayudarte?",
              "type": "string"
            },
            {
              "id": "1304d926-627c-4af5-897b-70e61caabbbe",
              "name": "from",
              "value": "={{ $json.from }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1056,
        9728
      ],
      "id": "ee27e4b0-99e4-49a6-9022-3224504299ca",
      "name": "Otro"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -816,
        5504
      ],
      "id": "06b08845-3c1d-4a2e-bab7-21e8f4ef52be",
      "name": "Unir Respuestas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -336,
        5520
      ],
      "id": "f9c42958-e60d-4404-ae5f-7284ac8f11f4",
      "name": "Enviar WhatsApp",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -96,
        5328
      ],
      "id": "db822409-b808-476a-90fd-c3b46697cec8",
      "name": "Confirmar a Meta"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ==================================================================\n//     SISTEMA PROFESIONAL DE INTENCIONES + BUSQUEDA DE PRODUCTOS\n// ==================================================================\n\n// ----------------------\n//     1. JSON Seguro\n// ----------------------\nfunction safeParseJSON(raw, def = {}) {\n  try {\n    if (!raw) return def;\n    if (typeof raw === \"object\") return raw;\n\n    let cleaned = String(raw)\n      .trim()\n      .replace(/\\r/g, \"\")\n      .replace(/\\n\\s*/g, \"\")\n      .replace(/\\t/g, \"\")\n      .replace(/,\\s*}/g, \"}\")\n      .replace(/,\\s*\\]/g, \"]\");\n\n    return JSON.parse(cleaned);\n  } catch (err) {\n    return def;\n  }\n}\n\n// --------------------------------- \n//     2. Sesi√≥n limpia y segura\n// ---------------------------------\nfunction generateIntegrityToken() {\n  return Math.random().toString(36).substring(2, 10) + Date.now().toString(36);\n}\n\nfunction normalizeSession(session = {}) {\n  return {\n    state: session.state || \"idle\",\n    data: safeParseJSON(session.data, {}),\n    integrityToken: session.integrityToken || generateIntegrityToken(),\n  };\n}\n\n// =======================\n//     INPUT desde n8n\n// =======================\nconst input = $input.item.json;\n\nconst textoOriginal = input.messageText || \"\";\nconst userName = input.userName || \"\";\nconst from = input.from || \"\";\nconst session = normalizeSession(input.session || {});\n\nlet debug = [];\n\n// ==============================\n//     NORMALIZACI√ìN DE TEXTO\n// ==============================\nfunction normalizeQuery(t) {\n  return String(t || \"\")\n    .toLowerCase()\n    .trim()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\")\n    .replace(/[.,!?;:]/g, \" \")\n    .replace(/\\s+/g, \" \");\n}\n\nconst texto = normalizeQuery(textoOriginal);\n\n// ==================================\n//     DETECCI√ìN DE TIPO DE VENTA \n// ==================================\nfunction detectarTipoVenta(texto) {\n  const keywords_mayor = [\n    \"mayor\", \"mayorista\", \"al mayor\", \"por mayor\", \n    \"distribuidor\", \"distribucion\", \"negocio\", \"tienda\",\n    \"grandes cantidades\", \"cantidad\", \"muchas unidades\",\n    \"docena\", \"docenas\", \"caja\", \"cajas\", \"bulto\"\n  ];\n\n  const keywords_detal = [\n    \"detal\", \"detalle\", \"al detal\", \"por detal\",\n    \"una unidad\", \"un solo\", \"solo uno\", \"unidad\",\n    \"minorista\", \"consumidor final\", \"para mi\",\n    \"quiero uno\", \"necesito uno\"\n  ];\n\n  const cantidadMatch = texto.match(/(\\d+)\\s*(unidades|docenas|cajas)/);\n  if (cantidadMatch) {\n    const cantidad = parseInt(cantidadMatch[1]);\n    if (cantidad >= 12) return \"mayor\";\n  }\n\n  if (keywords_mayor.some(w => texto.includes(w))) return \"mayor\";\n  if (keywords_detal.some(w => texto.includes(w))) return \"detal\";\n\n  if (session.data.tipo_venta) return session.data.tipo_venta;\n\n  return \"mayor\";\n}\n\nconst tipoVenta = detectarTipoVenta(texto);\n\n// ======================\n//     Palabras clave\n// ======================\nconst keywords = {\n  saludo: [\"hola\",\"buen dia\",\"buenas\",\"saludos\",\"hey\",\"holi\"],\n  compra:[\"comprar\",\"compra\",\"quiero comprar\"],\n  catalogo: [\"catalogo\",\"ver productos\",\"mostrar productos\"],\n  soporte: [\"ayuda\",\"soporte\",\"no funciona\"],\n  despedida: [\"gracias\",\"adios\",\"hasta luego\",\"bye\"],\n  pago: [\"pagar\",\"pago\",\"nequi\",\"daviplata\"],\n  pedido: [\"mi pedido\",\"estado\",\"seguimiento\"],\n  consulta_contextual: [\"horario\",\"hora\",\"atienden\",\"ubicacion\",\n                       \"direccion\",\"envio\",\"envian\",\"domicilio\",\n                       \"cuanto tarda\",\"tiempo de entrega\",\"formas de pago\",\n                       \"metodos de pago\",\"pago contra entrega\"]\n};\n\nfunction esConsultaTextual(texto) {\n  return keywords.consulta_contextual.some(w => texto.includes(w));\n}\n\nfunction detectarSubConsulta(texto) {\n  if (/(horario|hora|atienden|abren|cierran)/.test(texto)){\n    return \"horario\";\n  }\n\n  if (/(ubicacion|direccion|donde estan|donde qeudan)/.test(texto)){\n    return \"ubicacion\";\n  }\n\n  if (/(envio|envian|domicilio|entrega)/.test(texto)){\n    return \"envio\";\n  }\n\n  if (/(pago|pagos|metodos de pago|formas de pago|nequi|daviplata|efectivo)/.test(texto)){\n    return \"pagos\";\n  }\n\n  return \"otros\";\n}\n\nfunction incluye(lista, text) {\n  return lista.some(w => text.includes(w));\n}\n\n// ======================================\n//     Detector de intenci√≥n especial\n// ======================================\nfunction isConsultarProducto(texto) {\n  const patterns = [\n    /cuanto.*(vale|cuesta)/,\n    /precio/,\n    /tienen.*[a-z]/,\n    /busco/,\n    /hay.*[a-z]/,\n    /me interesa/,\n    /original|replica|barato|disponible/\n  ];\n\n  return patterns.some(r => r.test(texto));\n}\n\nfunction detectIntent(texto) {\n  if (\n    isConsultarProducto(texto) ||\n    incluye(keywords.compra, texto) ||\n    incluye(keywords.catalogo, texto)\n  ) {\n    return \"explorar_productos\";\n  };\n  if (incluye(keywords.pago, texto)) return \"awaiting.payment\";\n  if (incluye(keywords.pedido, texto)) return \"estado_pedido\";\n  if (incluye(keywords.soporte, texto)) return \"soporte\";\n\n  if (incluye(keywords.saludo, texto)) return \"saludo\";\n  \n  if (incluye(keywords.despedida, texto)) return \"despedida\";\n\n  if (texto.includes(\"detal\") || texto.includes(\"al detal\")) {\n    return \"cambiar_detal\";\n  }\n\n  return \"otro\";\n}\n\n// ==================================================\n// 3. Detecci√≥n de si el texto contiene un n√∫mero\n// ==================================================\nconst contieneNumero = /\\d+/.test(texto);\n\n// ==========================\n//     MANEJO POR ESTADOS\n// ==========================\n\nswitch (session.state) {\n\n  // -----------------------------------------------------------\n  case \"awaiting.confirmation\":\n    const afirmativas = [\"si\",\"claro\",\"ok\",\"acepto\",\"agregar\"];\n    const negativas = [\"no\",\"nunca\",\"cancelar\",\"no quiero\"];\n\n    if (afirmativas.some(w => texto.includes(w))) {\n      return {\n        json: {\n          intencion: \"confirmacion_positiva\",\n          from, userName,\n          sessionState: session.state,\n          sessionData: session.data,\n          sessionIntegrityToken: session.integrityToken,\n          texto_normalizado: texto,\n          debug\n        }\n      };\n    }\n\n    if (negativas.some(w => texto.includes(w))) {\n      return {\n        json: {\n          intencion: \"confirmacion_negativa\",\n          from, userName,\n          sessionState: session.state,\n          sessionData: session.data,\n          sessionIntegrityToken: session.integrityToken,\n          texto_normalizado: texto,\n          debug\n        }\n      };\n    }\n\n    if (esConsultaTextual(texto)) {\n      const subIntencion = detectarSubConsulta(texto);\n      \n      return {\n        json: {\n          intencion: \"consulta_contextual\",\n          sub_intencion: subIntencion,\n          from, userName,\n          sessionState: session.state,\n          sessionData: session.data,\n          sessionIntegrityToken: session.integrityToken,\n          texto_normalizado: texto,\n          debug\n        }\n      };\n    }\n    \n    return {\n      json: {\n        intencion: \"confirmacion_invalida\",\n        from, userName,\n        sessionState: session.state,\n        sessionData: session.data,\n        sessionIntegrityToken: session.integrityToken,\n        texto_normalizado: texto,\n        debug\n      }\n    };\n\n  // -------------------------------------------------\n\n  case \"awaiting.selection\":\n    const num = parseInt(texto);\n    if (!isNaN(num) && num > 0) {\n      return {\n        json: {\n          intencion: \"seleccion_producto\",\n          seleccionNumero: num,\n          from, userName,\n          sessionState: session.state,\n          sessionData: session.data,\n          sessionIntegrityToken: session.integrityToken,\n          texto_normalizado: texto,\n          debug\n        }\n      };\n    }\n\n    return {\n      json: {\n        intencion: \"seleccion_invalida\",\n        seleccionNumero: num,\n        from, userName,\n        sessionState: session.state,\n        sessionData: session.data,\n        sessionIntegrityToken: session.integrityToken,\n        texto_normalizado: texto,\n        debug\n      }\n    };\n\n  // ----------------------------------------------\n  case \"awaiting.product\":\n    return {\n      json: {\n        intencion: \"explorar_productos\",\n        from, userName,\n        sessionState: session.state,\n        sessionData: session.data,\n        sessionIntegrityToken: session.integrityToken,\n        texto_normalizado: texto\n      }\n    };\n\n  // -----------------------------------------------\n  case \"awaiting.delivery_address\":\n\n    return {\n      json: {\n        intencion: \"guardar_direccion_entrega\",\n        direccion_entrega: textoOriginal,\n        from,\n        userName,\n        sessionState: session.state,\n        sessionData: session.data,\n        sessionIntegrityToken: session.integrityToken,\n        texto_normalizado: texto,\n        tipo_venta: tipoVenta\n      }\n    };\n\n  // -----------------------------------------------\n  case \"awaiting.payment\": \n    const tieneOrden = !!session.data?.current_order;\n    const tieneDireccion = !!session.data?.delivery_address;\n\n    if (tieneOrden && !tieneDireccion) {\n      return {\n        json: {\n          intencion: \"pedir_direccion_entrega\",\n          from,\n          userName,\n          sessionState: \"awaiting.delivery_address\",\n          sessionData: session.data,\n          sessionIntegrityToken: session.integrityToken,\n          texto_normalizado: texto,\n          tipo_venta: tipoVenta\n        }\n      };\n    }\n    \n    // Detecta la intenci√≥n\n    const seguir = [\"seguir\", \"comprar\", \"seguir comprando\", \"ver productos\", \"otro\", \"mas\", \"volver\"];\n    const cancelar = [\"cancelar\", \"no\", \"salir\", \"parar\", \"anular\"];\n    const pagar = [\"pagar\", \"pagar ahora\", \"nequi\", \"daviplata\", \"efectivo\", \"tarjeta\", \"pago\"];\n\n    if (seguir.some(w => texto.includes(w))) {\n      return {\n        json: {\n          intencion: \"seguir_comprando\",\n          from, userName,\n          sessionState: session.state,\n          sessionData: session.data,\n          sessionIntegrityToken: session.integrityToken,\n          texto_normalizado: texto,\n          tipo_venta: tipoVenta\n        }\n      };\n    }\n\n    if (cancelar.some(w => texto.includes(w))) {\n      return {\n        json: {\n          intencion: \"cancelar_pedido\",\n          from, userName,\n          sessionState: session.state,\n          sessionData: session.data,\n          sessionIntegrityToken: session.integrityToken,\n          texto_normalizado: texto,\n        }\n      };\n    }\n\n    if (pagar.some(w => texto.includes(w))) {\n      return {\n        json: {\n          intencion: \"awaiting.payment\",\n          from, userName,\n          sessionState: session.state,\n          sessionData: session.data,\n          sessionIntegrityToken: session.integrityToken,\n          texto_normalizado: texto,\n        }\n      };\n    }\n    \n    return {\n      json: {\n        intencion: \"awaiting.payment\",\n        from, userName,\n        sessionState: session.state,\n        sessionData: session.data,\n        sessionIntegrityToken: session.integrityToken,\n        texto_normalizado: texto,\n      }\n    };\n\n  // -------------------------------------------------------------------------------\n  case \"awaiting.payment_confirmation\":\n    const yesPay = [\"si\",\"confirmo\",\"pagar\",\"dale\",\"vamos\",\"listo\"];\n    const noPay = [\"no\",\"cancelar\",\"despues\",\"luego\",\"mas tarde\"];\n\n    if (yesPay.some(w => texto.includes(w))) {\n      return {\n        json: {\n          intencion: \"confirmar_pago\",\n          from, userName,\n          sessionState: session.state,\n          sessionData: session.data,\n          sessionIntegrityToken: session.integrityToken,\n          texto_normalizado: texto,\n        }\n      };\n    }\n\n    if (noPay.some(w => texto.includes(w))) {\n      return {\n        json: {\n          intencion: \"cancelar_pago\",\n          from, userName,\n          sessionState: session.state,\n          sessionData: session.data,\n          sessionIntegrityToken: session.integrityToken,\n          texto_normalizado: texto,\n        }\n      };\n    }\n\n    return {\n      json: {\n        intencion: \"respuesta_invalida_payment_confirmation\",\n        message: \"Solo necesito que me confirmes ‚ò∫\\n\\n¬øDeseas *confirmar el pago* ahora?\",\n        from, userName,\n        sessionState: session.state,\n        sessionData: session.data,\n        sessionIntegrityToken: session.integrityToken,\n        texto_normalizado: texto,\n      }\n    };\n}\n\nif (session.state === \"awaiting.quantity\" && texto.includes(\"detal\")) {\n  return {\n    json: {\n      intencion: \"cambiar_detal\",\n      from,\n      userName,\n      texto_normalizado: texto,\n      sessionState: session.state,\n      sessionData: session.data,\n      sessionIntegrityToken: session.integrityToken,\n      tipo_venta: \"detal\",\n      debug\n    }\n  };\n}\n\n// =========================\n//     INTENCI√ìN GENERAL\n// =========================\n\nconst intencion = detectIntent(texto);\n\nreturn {\n  json: {\n    intencion,\n    contieneNumero,\n    from,\n    userName,\n    texto_normalizado: texto,\n    sessionState: session.state,\n    sessionData: session.data,\n    sessionIntegrityToken: session.integrityToken,\n    tipo_venta: tipoVenta,\n    debug\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2304,
        6096
      ],
      "id": "dfd74476-d0a1-4c0a-b487-7377e1604018",
      "name": "Clasificar por palabras clave"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Obtener los datos del merge\nconst from = $input.item.json.from;\nconst message = $input.item.json.message;\n\n// Construir el payload correcto para WhatsApp\nreturn {\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: from,\n    type: \"text\",\n    text: {\n      preview_url: false,\n      body: message\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        5520
      ],
      "id": "4da360af-70b7-434a-acb1-11d9bcdf3cfa",
      "name": "Preparar payload WhatsApp"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/logs",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "log_type",
              "value": "incoming"
            },
            {
              "name": "from_number",
              "value": "={{ $json.from }}"
            },
            {
              "name": "user_message",
              "value": "={{ $json.messageText }}"
            },
            {
              "name": "message_id",
              "value": "={{ $json.messageId }}"
            },
            {
              "name": "status",
              "value": "received"
            },
            {
              "name": "raw_data",
              "value": "={{ $json }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3504,
        6480
      ],
      "id": "4a7cdc8a-e96a-421f-ac05-ec2d37596b25",
      "name": "Log Incoming Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/logs",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "log_type",
              "value": "classification"
            },
            {
              "name": "from_number",
              "value": "={{ $json.from }}"
            },
            {
              "name": "user_message",
              "value": "={{ $json.texto_normalizado }}"
            },
            {
              "name": "intent",
              "value": "={{ $json.intencion }}"
            },
            {
              "name": "status",
              "value": "classified"
            },
            {
              "name": "raw_data",
              "value": "={{ $json }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2048,
        6304
      ],
      "id": "35ac1837-8bcb-4255-8142-4ed67e31cf03",
      "name": "Log Clasification message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/logs",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "log_type",
              "value": "outgoing"
            },
            {
              "name": "to_number",
              "value": "={{ $json.to_number }}"
            },
            {
              "name": "ai_response",
              "value": "={{ $json.ai_response }}"
            },
            {
              "name": "message_id",
              "value": "={{ $json.message_id }}"
            },
            {
              "name": "intent",
              "value": "={{ $json.intent }}"
            },
            {
              "name": "status",
              "value": "sent"
            },
            {
              "name": "raw_data",
              "value": "={{ $json }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        384,
        5632
      ],
      "id": "c86c95be-d26b-4038-8a7b-805565c21b85",
      "name": "Log Message Recived"
    },
    {
      "parameters": {
        "jsCode": "// Obtener todos los inputs\nconst inputs = $input.all();\n\nlet sentPayload, metaResponse, userData;\n\n// Identificar cada tipo de entrada\nfor (const input of inputs) {\n  if (input.json.messaging_product && input.json.to && input.json.text) {\n    // Este es el payload que enviamos a WhatsApp\n    sentPayload = input.json;\n  } else if (input.json.contacts && input.json.messages) {\n    // Esta es la respuesta de Meta\n    metaResponse = input.json;\n  } else if (input.json.intencion) {\n    // Estos son los datos del usuario con la intenci√≥n\n    userData = input.json;\n  }\n}\n\n// Fallback si no se identificaron\nif (!sentPayload) sentPayload = inputs[1]?.json || {};\nif (!metaResponse) metaResponse = inputs[0]?.json || {};\nif (!userData) userData = inputs[2]?.json || {};\n\n// Extraer to_number desde la respuesta de Meta\nconst toNumber = metaResponse.contacts?.[0]?.wa_id || \n                 metaResponse.contacts?.[0]?.input || \n                 userData.from || \"\";\n\n// Extraer message_id desde la respuesta de Meta\nconst messageId = metaResponse.messages?.[0]?.id || \"\";\n\n// Extraer ai_response desde el payload enviado\nconst aiResponse = sentPayload.text?.body || \"\";\n\n// Extraer la intenci√≥n desde userData\nconst intent = userData.intencion || \"\";\n\n// Construir el objeto de log\nreturn {\n  json: {\n    log_type: \"outgoing\",\n    to_number: toNumber,\n    ai_response: aiResponse,\n    message_id: messageId,\n    intent: intent,\n    status: \"sent\",\n    raw_data: {\n      sent_payload: sentPayload,\n      meta_response: metaResponse,\n      user_data: userData\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        128,
        5744
      ],
      "id": "0fec93e2-e2db-481e-9946-73687b6d3f71",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -96,
        5728
      ],
      "id": "bc728b5e-1cd4-4c2f-b2c6-2bc22a51cbce",
      "name": "Merge"
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_API_URL }}/api/products/search?search={{$json.searchTerm}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -96,
        5152
      ],
      "id": "04b0b42e-16ac-45af-8c97-a8c908156d8d",
      "name": "Buscar producto",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "dfb33b7e-7b15-4a03-87cd-30be5b255005",
              "name": "searchTerm",
              "value": "={{ $json.terminoBusqueda }}",
              "type": "string"
            },
            {
              "id": "f0155855-948b-47b3-8999-30b4ba85f685",
              "name": "clientName",
              "value": "={{ $json.userName }}",
              "type": "string"
            },
            {
              "id": "bf6ca6a2-49f4-4594-856e-875248eecc90",
              "name": "clientPhone",
              "value": "={{ $json.from }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -592,
        4784
      ],
      "id": "cf965694-0c56-4790-bf57-37e09bb76493",
      "name": "Preparar consulta del producto"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"ignored\",\n  \"reason\": \"status_update\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -3264,
        6480
      ],
      "id": "3b052c7f-ced9-42eb-b9e5-7350ffcc2bc8",
      "name": "Mensaje no valido"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "41de879a-a73d-4d58-a6f6-03ff5329ed29",
              "leftValue": "={{ $json.searchTerm }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            },
            {
              "id": "94811fef-5a14-4868-89e4-8947688f1f7e",
              "leftValue": "={{ $json.searchTerm.trim() }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -352,
        4784
      ],
      "id": "b36ea54e-a394-4a05-83e7-3694a0c3b257",
      "name": "¬øNecesita informaci√≥n?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9bee4027-e3c5-4f5c-9fcb-0810ab66fcf8",
              "name": "clientPhone",
              "value": "={{ $json.clientPhone }}",
              "type": "string"
            },
            {
              "id": "a279f9aa-cd01-46f0-9fba-1a4e8fe7e7d8",
              "name": "clientName",
              "value": "={{ $json.clientName }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -96,
        4416
      ],
      "id": "7d11b055-d594-48a5-9f8e-1c69ec5879ca",
      "name": "Preparar mensaje para pedir info"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.clientPhone || $json.user_phone }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"{{ $json.clientName }} üëã\\n\\nNecesito un poco m√°s de informaci√≥n para ayudarte.\\n\\nPor favor dime *qu√© producto buscas*, puede ser el nombre, referencia, categor√≠a o marca.\\n\\nEjemplos:\\n‚Ä¢ *cargador samsung*\\n‚Ä¢ *case iphone 12*\\n‚Ä¢ *aud√≠fonos inal√°mbricos*\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        128,
        4576
      ],
      "id": "010cd1aa-895e-49e5-9c02-6fa5754a0dcf",
      "name": "Pedir info",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        368,
        4672
      ],
      "id": "db838f4e-cba5-47bb-a6f2-11f38f1550c8",
      "name": "Confirmar a Meta - Pedir info"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"user_phone\": \"={{$json.from}}\",\n  \"state\": \"awaiting.product\",\n  \"data\": {\n    \"order_id\": \"={{$json.sessionData.order_id}}\",\n    \"total\": \"={{$json.sessionData.total}}\",\n    \"pending_payment\": \"={{$json.sessionData.pending_payment}}\",\n    \"expected_confirmation\": \"={{$json.sessionData.expected_confirmation}}\",\n    \"timestamp\": \"{{ new Date().toISOString() }}\",\n    \"clientName\": \"={{$json.userName}}\",\n    \"needsInput\": true,\n    \"tipo_venta\": \"mayor\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        128,
        4256
      ],
      "id": "40d7e874-b37a-46e2-8cfd-69b99692b0ad",
      "name": "Preparar JSON - Esperando Producto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "=user_phone",
              "value": "={{ $json.user_phone }}"
            },
            {
              "name": "state",
              "value": "={{ $json.state }}"
            },
            {
              "name": "data",
              "value": "={{ $json.data }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        368,
        4256
      ],
      "id": "4a3a84b2-b3b8-43ef-82f3-3b91abe44607",
      "name": "Guardar estado - Esperando producto"
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions/{{ $json.from }}",
        "options": {
          "allowUnauthorizedCerts": false
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3264,
        6096
      ],
      "id": "af82741e-6b1b-4d50-8a91-d432c162e9ad",
      "name": "Obtener estado de conversaci√≥n",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -2544,
        6096
      ],
      "id": "7e2cf176-d429-4676-8f04-11a194ea37e9",
      "name": "Estado / Datos"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// =========================================\n// ==== VALIDACI√ìN COMPLETA DE CANTIDAD ====\n// =========================================\n\nconst rawText = ($json.texto_normalizado || '').trim();\nconst sessionState = $json.sessionState || \"idle\";\nconst sessionData = $json.sessionData || {};\n\n// Si NO estamos en awaiting_quantity ‚Üí no hacemos nada especial\nif (sessionState !== \"awaiting.quantity\") {\n  return {\n    json: {\n      ...$json,\n      awaiting_quantity: {\n        isActive: false,\n        isValidQuantity: false,\n        quantity: null,\n        reason: \"NotAwaiting\"\n      }\n    }\n  };\n}\n\n// Extrae el n√∫mero del texto\nlet extractedNumber = null;\n\nif (!isNaN(parseInt(rawText))) {\n  extractedNumber = parseInt(rawText);\n} else {\n  const found = rawText.match(/\\d+/);\n  if (found) {\n    extractedNumber = parseInt(found[0]);\n  }\n}\n\n// Validaci√≥n\nconst isValidNumber = extractedNumber !== null && extractedNumber > 0;\n\nconst tipoVenta = sessionData.tipo_venta || $json.tipo_venta || \"mayor\";\n\nlet minQuantityValidation = {\n  isValid: true,\n  minimumRequired: tipoVenta === \"mayor\" ? 12 : 1,\n  reason: null\n};\n\nif (isValidNumber && tipoVenta === \"mayor\") {\n  if (extractedNumber < 12) {\n    minQuantityValidation = {\n      isValid: false,\n      minimumRequired: 12,\n      requestedQuantity: extractedNumber,\n      reason: \"BelowMinimumForMayor\"\n    };\n  }\n}\n\nlet stockValidation = {\n  hasStock: true,\n  available: null,\n  reason: null\n};\n\nif (isValidNumber && minQuantityValidation.isValid) {\n  const productStock = sessionData.product_existencias || sessionData.existencias || 0;\n\n  if (extractedNumber > productStock) {\n    stockValidation = {\n      hasStock: false,\n      available: productStock,\n      requestQuantity: extractedNumber,\n      reason: \"InsufficientStock\"\n    };\n  }\n}\n\nconst isValid = isValidNumber && minQuantityValidation.isValid && stockValidation.hasStock;\n\nlet finalReason = \"OK\";\nif (!isValidNumber) {\n  finalReason = \"InvalidNumber\";\n} else if (!minQuantityValidation.isValid) {\n  finalReason = \"BelowMinimumForMayor\";\n} else if (!stockValidation.hasStock) {\n  finalReason = \"InsufficientStock\";\n}\n\n// Construcci√≥n del resultado\nreturn {\n  json: {\n    ...$json,\n    awaiting_quantity: {\n      isActive: true,\n      isValidQuantity: isValid,\n      quantity: isValidNumber ? extractedNumber : null,\n      tipoVenta: tipoVenta,\n      minQuantityValidation: minQuantityValidation,\n      stockValidation: stockValidation,\n      reason: finalReason\n    },\n    sessionData: {\n      ...sessionData,\n      quantity: isValid ? extractedNumber : null\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1072,
        -2192
      ],
      "id": "336b9139-eacd-4da9-897f-5fa35cfbf916",
      "name": "Validar cantidad"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9cac9503-e12f-4bf3-b48e-42262a729b96",
              "name": "product_found",
              "value": "={{ $json.products ? true : false }}",
              "type": "string"
            },
            {
              "id": "f1fd98cf-dd54-4a8d-95a9-bdc772673433",
              "name": "product_id",
              "value": "={{ $json.producto.id }}",
              "type": "string"
            },
            {
              "id": "02f799f8-5cd7-45a1-9a4c-1c67665eab00",
              "name": "product_name",
              "value": "={{ $json.producto.nombre }}",
              "type": "string"
            },
            {
              "id": "e3d00866-42fd-4106-b2cc-58d189b25b31",
              "name": "product_price",
              "value": "={{ $json.producto.precio }}",
              "type": "string"
            },
            {
              "id": "d2dd607a-f5fd-4ce3-83b2-0d8c73e55fc9",
              "name": "product_stock",
              "value": "={{ $json.producto.existencias }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        4304
      ],
      "id": "b4c100b8-9115-4f97-981a-9be943166eb9",
      "name": "Encontr√≥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"¬°Ups! No pude encontrar nada con esa descripci√≥n üòï\\n\\n¬øPodr√≠as darme un dato m√°s? Quiz√° la marca, el color o algo parecido.\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1136,
        5280
      ],
      "id": "dfa3f6b6-24be-4535-9ff1-a9b9e00fd9ac",
      "name": "Enviar mensaje No encontr√©",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.from }}"
            },
            {
              "name": "state",
              "value": "awaiting.confirmation"
            },
            {
              "name": "data",
              "value": "={\n  \"product_id\": \"{{ $json.product_id }}\",\n  \"product_name\": \"{{ $json.product_name }}\",\n  \"product_price\": {{ $json.product_price }},\n  \"product_stock\": {{ $json.product_stock }},\n  \"tipo_venta\": \"mayor\"\n}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1824,
        4576
      ],
      "id": "f63e2761-65b0-4cbc-9cb0-d7cb4e6445fe",
      "name": "Guardar estado - Confirmar producto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"Encontr√© este producto:\\n{{ $json.product_name }}\\nPrecio: ${{ $json.product_price }}\\n¬øDeseas agregarlo a tu pedido?\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1824,
        4032
      ],
      "id": "11b609ce-1fd9-4e16-88b6-627a192a0ce5",
      "name": "Enviar mensaje Encontr√©",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        2064,
        3840
      ],
      "id": "a41a6706-1da7-4a70-9264-5991280127ea",
      "name": "Confirmar a Meta - Encontr√©"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1584,
        4304
      ],
      "id": "70dd4001-ed48-475b-ab8f-2f3f8f586593",
      "name": "Producto + Datos"
    },
    {
      "parameters": {
        "jsCode": "// Si no hay item, devolvemos vac√≠o.\nconst item = $input.first().json;\n\nfunction roundToTwo(num) {\n  return Math.round((num + Number.EPSILON) * 100) / 100;\n}\n\nreturn {\n  json: {\n    product_id: item.product_id,\n    product_name: item.product_name,\n    product_price: roundToTwo(parseFloat(item.product_price || 0)),\n    product_stock: item.product_stock,\n    product_found: item.product_found === \"true\"\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        4304
      ],
      "id": "8b9160d5-a842-43d0-b553-18271e1da9b0",
      "name": "Flatten Product Result"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"user_phone\": \"{{ $json.from }}\",\n  \"state\": \"awaiting.quantity\",\n  \"data\": {\n    \"order_id\": {{ $json.sessionData.session?.order_id || null }},\n    \"total\": {{ $json.sessionData.session?.total || 0 }},\n    \"pending_payment\": \"{{ $json.sessionData.session?.pending_payment || false }}\",\n    \"expected_confirmation\": \"{{ $json.sessionData.session?.expected_confirmation || null }}\",\n\n    \"product_id\": {{ $json.sessionData.current_selection ? $json.sessionData.current_selection.producto_seleccionado.id : $json.sessionData.product_id }},\n    \"product_name\": \"{{ $json.sessionData.current_selection ? $json.sessionData.current_selection.producto_seleccionado.nombre : $json.sessionData.product_name }}\",\n    \"product_price\": {{ $json.sessionData.current_selection ? $json.sessionData.current_selection.producto_seleccionado.precio : $json.sessionData.product_price }},\n    \"product_existencias\": {{ $json.sessionData.current_selection ? $json.sessionData.current_selection.producto_seleccionado.existencias : $json.sessionData.product_stock }},\n    \"tipo_venta\": \"mayor\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -816,
        -960
      ],
      "id": "ebdcacb6-110c-44ef-9fe8-6d609daaf310",
      "name": "Producto confirmado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.user_phone }}"
            },
            {
              "name": "state",
              "value": "={{ $json.state }}"
            },
            {
              "name": "data",
              "value": "={{ $json.data }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        -736
      ],
      "id": "456581da-99ba-42d9-8493-577a42dbaf9a",
      "name": "Actualizar sesi√≥n"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.user_phone }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"Perfecto, agregar√© *{{ $json.data.product_name }}* a tu pedido.\\n\\n¬øCuantas unidades deseas?\\n\\nüí° *Recuerda:* Para compra al MAYOR necesitas m√≠nimo *12 unidades*.\\n\\nSi prefieres comprar menos unidades, puedo redirigirte a nuestro equipo de ventas al *DETAL*.\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        -1168
      ],
      "id": "4cfb934b-a853-401c-ab88-ea07e6b3639c",
      "name": "Enviar mensaje Pedir cantidad",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2c535d3a-9d15-4e9c-99a8-b87e211c8483",
              "name": "newState",
              "value": "awaiting.product",
              "type": "string"
            },
            {
              "id": "e59cc1b0-24d2-435c-97a7-07c60b8acacc",
              "name": "from",
              "value": "={{ $json.from }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -816,
        -272
      ],
      "id": "df949367-a7df-4661-8f23-7e9e7a9cc0f1",
      "name": "Rechaz√≥"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -352,
        -1056
      ],
      "id": "1567aa67-a7e6-4158-9cdb-0a7ffe725e11",
      "name": "Confirmar a Meta - Pedir cantidad"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"No hay problema üòä\\n\\nCu√©ntame, ¬øqu√© producto deseas comprar?\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        -416
      ],
      "id": "50a94dc8-905d-4cc5-a821-04acd909146a",
      "name": "Enviar mensaje Consultar producto",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -352,
        -320
      ],
      "id": "59dbf5e8-6ad3-47a4-9cda-1fa023ee2020",
      "name": "Confirmar a Meta Consultar producto"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1344,
        5184
      ],
      "id": "a0f37db7-e8d5-4c39-ad30-b0490fe6f513",
      "name": "Confirmar a Meta - No Encontr√©"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"user_phone\": \"{{ $json.from }}\",\n  \"state\": \"awaiting.selection\",\n  \"data\": {\n    \"needsSelection\": true,\n    \"products\": {{ $json.sugerencias }},\n    \"total\": {{ $json.sessionData.total || 0 }},\n    \"order_id\": {{ $json.sessionData.order_id || null }},\n    \"pending_payment\": \"{{ $json.sessionData.pending_payment || false }}\",\n    \"expected_confirmation\": \"{{ $json.sessionData.expected_confirmation || null }}\",\n    \"tipo_venta\": \"mayor\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        4864
      ],
      "id": "c40b5991-e3ee-463c-9897-0d057077ae90",
      "name": "M√∫ltiples productos encontrados"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.user_phone }}"
            },
            {
              "name": "state",
              "value": "={{ $json.state }}"
            },
            {
              "name": "data",
              "value": "={{ $json.data }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1344,
        4736
      ],
      "id": "73d4a477-878f-4daf-8daa-f819c50b9439",
      "name": "Guardar estado - Seleccionar Producto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "messaging_product",
              "value": "whatsapp"
            },
            {
              "name": "to",
              "value": "={{ $json.to }}"
            },
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "text",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1584,
        4992
      ],
      "id": "2e2e66a9-102e-4233-8228-2ea9a6f0f0df",
      "name": "Enviar mensaje Encontr√© >1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1824,
        4992
      ],
      "id": "cd680349-e586-44d7-a3d9-18384f0466c4",
      "name": "Confirmar a Meta - Encontr√© > 1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7ccf6f43-9da3-424c-9a11-dfc8e295c57c",
              "name": "numero_usuario",
              "value": "={{ Number($json.seleccionNumero) }}",
              "type": "string"
            },
            {
              "id": "6892125d-5f53-4d24-b9da-ba82f25ee301",
              "name": "session",
              "value": "={{ $json.sessionData }}",
              "type": "object"
            },
            {
              "id": "017e15c5-89d8-41df-8152-0639b446d6c9",
              "name": "user_phone",
              "value": "={{ $json.from }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1024,
        3680
      ],
      "id": "e02e0367-cf00-4519-af9f-319f91fc1541",
      "name": "N√∫mero seleccionado"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "53f78066-508f-4641-8507-e6db63f12626",
              "leftValue": "={{ Number($json.numero_usuario) }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "3b0967a6-786e-4851-9712-6ae7a20e04bb",
              "leftValue": "={{ Number($json.numero_usuario) }}",
              "rightValue": "={{ $json.session.products.length }}",
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -752,
        3680
      ],
      "id": "1f556baa-8ea4-4cdd-bb53-87f9d49cd50b",
      "name": "¬øEs v√°lido?"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"user_phone\": \"{{ $json.user_phone }}\",\n  \"state\": \"awaiting.confirmation\",\n  \"data\": {\n    \"current_selection\": {\n      \"producto_seleccionado\": {{ $json.session.products[$json.numero_usuario - 1] }},\n      \"needsSelection\": false,\n      \"tipo_venta\": \"mayor\"\n    },\n    \"session\": {{ $json.session }},\n    \"product_existencias\": {{ $json.session.products[$json.numero_usuario - 1].existencias }}\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -352,
        3440
      ],
      "id": "3a95e80b-76d6-4df2-ad36-dd8fbadce2e9",
      "name": "Seleccionar producto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.user_phone }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"Has seleccionado:\\n\\n*{{ $json.data.current_selection.producto_seleccionado.nombre }}*\\nPrecio: ${{ $json.data.current_selection.producto_seleccionado.precio }}\\n\\n¬øDeseas confirmar la compra? (si/no)\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -96,
        3296
      ],
      "id": "fda51e28-ecc0-4c93-82e2-16031c0c5dc1",
      "name": "Enviar mensaje Producto Seleccionado",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        208,
        3184
      ],
      "id": "12ef81dd-c77f-402f-9c03-ee11298a180e",
      "name": "Confirmar a Meta - Confirmar Producto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.user_phone }}"
            },
            {
              "name": "state",
              "value": "={{ $json.state }}"
            },
            {
              "name": "data",
              "value": "={{ $json.data }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -96,
        3584
      ],
      "id": "b59ce570-5abf-4ea0-82f9-d16647be1fbf",
      "name": "Actualizar sesi√≥n - Awaiting Confirmation"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.user_phone }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"‚ùå El n√∫mero ingresado no es v√°lido.\\n\\nPor favor selecciona una opci√≥n del 1 al {{ $json.session.products.length }}.\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -352,
        3888
      ],
      "id": "a654dc58-7cba-4e4e-a3ba-ede272b56549",
      "name": "Enviar mensaje N√∫mero Invalido",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -96,
        4000
      ],
      "id": "4eabf1e1-89a1-4933-a4d8-8be050f51a32",
      "name": "Confirmar a Meta - N√∫mero Inv√°lido"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        624,
        4864
      ],
      "id": "39b768e9-915b-4b35-9742-3c3ae89ac5c5",
      "name": "No Producto + Datos"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intencion }}",
                    "rightValue": "confirmacion_positiva",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c9e6f859-92f8-4a7e-b5fa-7c7fad3bbeac"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirmaci√≥n positiva"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1efcfbd3-4611-477e-b9a9-0abc9869f2aa",
                    "leftValue": "={{ $json.intencion }}",
                    "rightValue": "confirmacion_negativa",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirmaci√≥n negativa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "22a3e781-d484-4ce0-9ce7-f5b851671772",
                    "leftValue": "={{ $json.intencion }}",
                    "rightValue": "consulta_contextual",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Consulta contextual"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fcf97b0e-d827-40b6-8747-cf84b8c9d7f1",
                    "leftValue": "={{ $json.intencion }}",
                    "rightValue": "confirmacion_invalida",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirmaci√≥n inv√°lida"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -1152,
        32
      ],
      "id": "89dcc5be-444f-4a75-b3d4-50cd97b139e4",
      "name": "¬øConfirm√≥?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ea4eb2b4-dd9d-4e55-8057-b37e73bcbad5",
              "leftValue": "={{ $json.awaiting_quantity.isValidQuantity }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "5611cd4a-68d6-43a6-90e7-87c3d74d39e9",
              "leftValue": "={{ $json.awaiting_quantity.stockValidation.hasStock }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -832,
        -2192
      ],
      "id": "235db7a0-5ddb-48ea-b163-0c67f9026048",
      "name": "¬øEs valida?"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// =============================================\n// ====   awaiting.quantity ‚Üí DECISION MAKER   ====\n// =============================================\n\nconst text = ($json.texto_normalizado || '').trim();\nconst session = $json.sessionData || {};\nconst sessionState = $json.sessionState;\n\nif (sessionState !== \"awaiting.quantity\") {\n  return {\n    json: {\n      error: true,\n      reason: \"NotAwaitingQuantity\"\n    }\n  };\n}\n\nlet quantity = null;\nconst found = text.match(/\\d+/);\nif (found) quantity = parseInt(found[0]);\n\nif (!quantity || quantity <= 0) {\n  return {\n    json: {\n      isValidQuantity: false,\n      reason: \"InvalidQuantity\"\n    }\n  };\n}\n\nconst product_id = session.product_id;\nconst client_name = $json.userName || \"Cliente\";\nconst client_phone = $json.from;\n\nconst hasOrder = Boolean(session.order_id);\n\nconst action = hasOrder ? \"add_item\" : \"create_order\";\n\n// SALIDA LISTA PARA EL HTTP REQUEST\nreturn {\n  json: {\n    isValidQuantity: true,\n    action,\n    quantity,\n    product_id,\n    client_name,\n    client_phone,\n    order_id: hasOrder ? session.order_id : null\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        -2432
      ],
      "id": "b3cbc80d-2d76-4ee0-b50f-d4bfb1220927",
      "name": "Guardar cantidad"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/orders",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"customer\": {\n    \"name\": \"{{ $json.client_name }}\",\n    \"phone\": \"{{ $json.client_phone }}\"\n  },\n  \"items\": [\n    {\n      \"product_id\": \"{{ $json.product_id }}\",\n      \"quantity\": {{ $json.quantity }}\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -160,
        -2912
      ],
      "id": "28cd140a-0b46-47e6-a441-d39497a8bd17",
      "name": "POST Crear Orden"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "messaging_product",
              "value": "={{ $json.messaging_product }}"
            },
            {
              "name": "to",
              "value": "={{ $json.to }}"
            },
            {
              "name": "type",
              "value": "={{ $json.type }}"
            },
            {
              "name": "text",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        784,
        -3040
      ],
      "id": "90fef3dd-e764-49c0-8b1f-f111280906ae",
      "name": "Enviar mensaje Producto Agregado",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1008,
        -2944
      ],
      "id": "00927e50-2398-4beb-bb7a-5292e2bf1880",
      "name": "Confirmar a Meta - Producto Agregado"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        336,
        -2912
      ],
      "id": "2a4432d8-4312-4a03-b08c-6f099ed6495b",
      "name": "Datos + Producto agregado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"user_phone\": \"{{ $json.data.client_phone }}\",\n  \"state\": \"awaiting.payment\",\n  \"data\": {{ JSON.stringify({\n    tipo_venta: \"mayor\",\n    current_order: {\n      order_id: $json.data.id,\n      total: $json.data.total,\n      payment_status: $json.data.payment_status\n    },\n    cart: $json.data.items\n  }) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        528,
        -2800
      ],
      "id": "4e2956de-894b-44fe-a0f9-b4be4deaddc4",
      "name": "Guardar estado - awaiting_next_action"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const input = $input.item.json;\nconst sessionData = input.sessionData || {}\nconst from = input.from;\nconst userName = input.userName;\n\nconst message =\n  `¬°Perfecto ${userName}! üëç\\n\\n` +\n  `Tu pedido est√° listo para pago.\\n\\n` +\n  `üìû *Un agente de nuestro equipo se comunicar√° contigo pronto* para coordinar el pago y la entrega.\\n\\n` +\n  `üìù *Resumen de tu orden:*\\n` +\n  `üí∞ Total: $${sessionData.current_order?.total?.toLoxaleString('es-CO') || 0}\\n\\n` +\n  `‚è∞ *Tiemp estimado de respuesta:* 15-30 minutos\\n\\n` +\n  `Si tienes alguna pregunta urgente, escribe *soporte*.`;\n\nreturn {\n  json: {\n    whatsapp_message: {\n      messaging_product: \"whatsapp\",\n      to: from,\n      type: \"text\",\n      text: {\n        preview_url: false,\n        body: message\n      }\n    },\n    session: {\n      user_phone: from,\n      state: \"awaiting.payment\",\n      data: {\n        tipo_venta: \"mayor\",\n        current_order: sessionData.current_order,\n        awaiting_agent: true,\n        agent_notified_at: new Date().toISOString()\n      }\n    }\n  }\n};\n  "
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        2224
      ],
      "id": "5517109a-ed96-4da5-a735-81e9594c7cf6",
      "name": "Metodo Pago"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "procesar_pago",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "00917243-1251-4be5-adf7-751f8f9cebe4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Procesar pago"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "09c5c3a0-c153-4992-8dbb-ec1452f0332f",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "volver_a_productos",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Volver"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0a10f1af-814b-4ffd-933a-67f59be57619",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "cancelar_pedido",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancelar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ad4cb1d2-7f31-452a-9f6a-8505f85c2a79",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "respuesta_invalida",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Error"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -816,
        2192
      ],
      "id": "b367598a-5f9c-4694-bed4-8d65e2ec0cd0",
      "name": "awaiting_payment_actions"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/payments",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "order_id",
              "value": "={{ $json.session.data.current_order.order_id }}"
            },
            {
              "name": "gateway",
              "value": "wompi"
            },
            {
              "name": "payment_link",
              "value": "={{ $json.session.data.current_order.payment_link }}"
            },
            {
              "name": "reference",
              "value": "={{ $json.session.data.current_order.reference }}"
            },
            {
              "name": "status",
              "value": "pending"
            },
            {
              "name": "amount",
              "value": "={{ $json.session.data.current_order.amount }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1504,
        1072
      ],
      "id": "ec271b92-382b-436a-982b-b9461ac727c2",
      "name": "Crear Pago"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.whatsapp }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1504,
        1600
      ],
      "id": "9dfc1331-08b9-456a-a199-cb870cdd5bb2",
      "name": "Enviar mensaje Payment",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.session.user_phone }}"
            },
            {
              "name": "state",
              "value": "awaiting.payment_confirmation"
            },
            {
              "name": "data",
              "value": "={\n  \"order_id\": \"{{ $json.session.data.current_order.order_id }}\",\n  \"total\": {{ $json.session.data.current_order.amount }},\n  \"payment_method\": \"{{ $json.meta.payment_method }}\",\n  \"pending_payment\": true,\n  \"expected_confirmation\": \"payment_confirmation\",\n  \"tipo_venta\": \"mayor\"\n}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1504,
        1904
      ],
      "id": "d4295101-e457-4e52-82c6-fd39ae5a588e",
      "name": "Guardar estado - awaiting_payment_confirmation"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1792,
        1712
      ],
      "id": "5b95a80e-53f9-467b-b545-27b7b4d08c68",
      "name": "Confirmar a Meta Payment"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"No pude detectar tu m√©todo de pago üòï.\\n\\nElige una opci√≥n:\\nüíú Nequi\\n‚ù§ Daviplata\\nüíµ Efectivo\\nüí≥ Tarjeta\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        3088
      ],
      "id": "d66b2525-eadd-427e-854e-c1edbb756514",
      "name": "send_whatsapp_invalid_payment_response",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -368,
        3184
      ],
      "id": "5086161b-395e-40d2-a1a7-a2ab93ce7ee5",
      "name": "Confirmar a Meta Invalid Payment"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_received"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3760,
        6480
      ],
      "id": "60f5e281-4504-42f3-a352-8d659a5db412",
      "name": "Register Analytics - message_received"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1008,
        -3152
      ],
      "id": "46d39272-3149-4d40-bd93-2628b32ec472",
      "name": "Register Analytics - message_sent - Producto agregado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -352,
        -1264
      ],
      "id": "f09bea79-6851-40e3-ae62-6ab3abe5e1c6",
      "name": "Register Analytics - message_sent - Pedir cantidad"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -352,
        -528
      ],
      "id": "3e6720b7-8bbd-43b6-9a95-1d85e54b8b03",
      "name": "Register Analytics - message_sent - Consultar producto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1792,
        1504
      ],
      "id": "dbc13746-caf8-40f8-a6a1-62411670370f",
      "name": "Register Analytics - message_sent - Payment"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -368,
        2992
      ],
      "id": "d6f1f94c-0753-4a7a-ba51-0fd85d6e8f80",
      "name": "Register Analytics - message_sent - Payment Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        208,
        3376
      ],
      "id": "fec9db03-d51b-46c7-a10d-fc90c770f453",
      "name": "Register Analytics - message_sent - Producto seleccionado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -96,
        3792
      ],
      "id": "d1c2e9e6-f8c5-4481-a7cd-a36c60e6e9b7",
      "name": "Register Analytics - message_sent - Numero inv√°lido"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        368,
        4464
      ],
      "id": "e7b6fd9e-2e8c-44f8-b0e9-5b8cb916b344",
      "name": "Register Analytics - message_sent - Pedir info"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1824,
        5184
      ],
      "id": "efb9be73-6ff9-4205-9371-d58aa51063df",
      "name": "Register Analytics - message_sent - Encontr√© > 1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1344,
        5392
      ],
      "id": "74c62055-5bf3-4be6-a3b4-e0083f3cda4f",
      "name": "Register Analytics - message_sent - No encontr√©"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -96,
        5520
      ],
      "id": "31e3f76b-cd4e-4431-b47e-9073c33dee8f",
      "name": "Register Analytics - message_sent -"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2064,
        4032
      ],
      "id": "67d26c01-4468-4238-9760-5d49dc3e429d",
      "name": "Register Analytics - message_sent - Encontr√©"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "189f9a0d-e546-484b-baa1-bb4cee4f89eb",
              "leftValue": "={{ $json.session.data }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3056,
        5888
      ],
      "id": "2e3694c3-8da5-432b-b037-5a84f8aa9ce6",
      "name": "¬øExist√≠a sesi√≥n?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_started"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2816,
        5872
      ],
      "id": "8626e16b-f66c-43b9-8596-5200242d4315",
      "name": "Register Analytics - session_started"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:awaiting.payment"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        784,
        -2800
      ],
      "id": "8e1090e4-ab15-47ad-8987-33d4d11aed25",
      "name": "Register Analytics - session_state_changed"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:awaiting_quantity"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -352,
        -736
      ],
      "id": "9b012ee9-fb12-4f38-b1c2-6996c0908876",
      "name": "Register Analytics - session_state_changed - awaiting_quantity"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:idle"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -352,
        -128
      ],
      "id": "23cb6aa1-e0e9-4069-9680-1bb5f55b42f1",
      "name": "Register Analytics - session_state_changed - Idle"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:awaiting_payment_confirmation"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1792,
        1904
      ],
      "id": "25455309-19c1-4f75-808e-dce634dea9f7",
      "name": "Register Analytics - session_state_changed - awaiting_payment_confirmation"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:awaiting_confirmation"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        208,
        3584
      ],
      "id": "c30c89f5-7913-46b8-ada4-0b3b2d891bf7",
      "name": "Register Analytics - session_state_changed - awaiting_confirmation"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:awaiting_product"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        608,
        4256
      ],
      "id": "8d301dde-9073-4c60-b1b9-69db2b43b4aa",
      "name": "Register Analytics - session_state_changed - awaiting_product"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:awaiting_selection"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1584,
        4736
      ],
      "id": "184c7c93-6728-499c-8a3c-e701349fb492",
      "name": "Register Analytics - session_state_changed - awaiting_selection"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:awaiting_confirmation"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2064,
        4576
      ],
      "id": "61144eee-df7f-4255-95ec-267c7efd3f44",
      "name": "Register Analytics - session_state_changed - awaiting_confirmation1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "product_view"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1824,
        4784
      ],
      "id": "185783d8-b9f7-4db3-b702-b9acef9b13b9",
      "name": "Register Analytics - product_view - Encontr√© > 1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "product_view"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2064,
        4240
      ],
      "id": "aa15f5e2-13f3-418e-a112-75e5242ef93a",
      "name": "Register Analytics - product_view - Encontr√© < 1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "checkout_started"
            },
            {
              "name": "value",
              "value": "={{ $json.data.product_price }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        -960
      ],
      "id": "c502b1bb-6c72-45dd-88da-5b30181ac6c3",
      "name": "Register Analytics - checkout_started - Pedir cantidad1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "payment_pending"
            },
            {
              "name": "value",
              "value": "={{ $json.session.data.current_order.amount }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1504,
        1312
      ],
      "id": "4716e35b-a5e3-4171-ba50-030c77738c4d",
      "name": "Register Analytics - payment_pending - Payment"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const data = $json;\n\n// Asegura la estructura\nconst productos = Array.isArray(data.products) ? data.products : [];\n\nlet respuestaTipo = \"sin_resultados\";\nlet sugerencias = [];\nlet producto = null;\nlet cantidad = productos.length;\n\nif (cantidad === 1) {\n  respuestaTipo = \"unico\";\n  const p = productos[0];\n\n  producto = {\n    id: p.id,\n    nombre: p.nombre,\n    precio: p.precio,\n    existencias: p.existencias,\n    imagen: p.url_imagen\n  };\n  \n} else if (cantidad > 1) {\n  respuestaTipo = \"sugerencias\";\n  sugerencias = productos.map(p => ({\n    id: p.id,\n    nombre: p.nombre,\n    precio: p.precio,\n    existencias: p.existencias,\n    imagen: p.url_imagen\n  }));\n}\n\nreturn {\n  respuestaTipo,\n  sugerencias,\n  producto,\n  cantidad\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        4864
      ],
      "id": "deb37862-dc32-410a-be30-dcc45419f3ad",
      "name": "Tipo de respuesta"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.respuestaTipo }}",
                    "rightValue": "unico",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c9e7d078-257d-414f-a269-f3e7ad9900a2"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Unico"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e9867140-04d2-41af-bcd6-503f528a918a",
                    "leftValue": "={{ $json.respuestaTipo }}",
                    "rightValue": "sugerencias",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Sugerencias"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "70a8ce23-93e3-4e93-b677-42331357cd4c",
                    "leftValue": "={{ $json.respuestaTipo }}",
                    "rightValue": "sin_resultados",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Sin resultados"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        880,
        4848
      ],
      "id": "f20a749d-386e-4cdd-82ca-f231df2ddbce",
      "name": "Tipo de respuesta1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.from }}"
            },
            {
              "name": "state",
              "value": "={{ $json.newState }}"
            },
            {
              "name": "data",
              "value": "={\n  \"tipo_venta\": \"mayor\"\n}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        -128
      ],
      "id": "b7c5bd35-ce6d-41a6-8f68-3a64309abe24",
      "name": "Actualizar sesi√≥n - awaiting.product"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"Hmm ü§î no estoy seguro de haber entendido tu respuesta.\\n\\nPor favor dime:\\nüëâ *s√≠* para continuar\\nüëâ *no* para cancelar\\n\\nAs√≠ puedo ayudarte mejor ‚ò∫\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -800,
        1168
      ],
      "id": "f38bbe68-07fa-4a90-b5aa-54cd7668d323",
      "name": "Enviar mensaje Mensaje inv√°lido",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        1056
      ],
      "id": "3b43f1a2-3ff4-4723-bf7b-8cb96174f0b0",
      "name": "Register Analytics - message_sent - mensaje inv√°lido"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -592,
        1280
      ],
      "id": "fea5e16d-d92c-49f5-b076-5dd026523943",
      "name": "Confirmar a Meta Mensaje inv√°lido"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"Ups üòÖ esa cantidad no parece v√°lida.\\n\\nPor favor escribe *solo un n√∫mero*, por ejemplo:\\n- 12\\n- 24\\n- 50\\n\\nüí° Recuerda: Para compra *AL MAYOR* necesitas m√≠nimo *12 unidades*.\\n\\n¬øCu√°ntas unidades deseas?\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -352,
        -2432
      ],
      "id": "caca5378-96c1-4aec-968e-e82b81b335fe",
      "name": "Enviar mensaje Cantidad inv√°lida",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -160,
        -2544
      ],
      "id": "a4087390-1127-4464-8680-264163a14f45",
      "name": "Register Analytics - message_sent - Cantidad inv√°lida"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -160,
        -2320
      ],
      "id": "306a9bd8-36e6-4252-92ff-39e939849117",
      "name": "Confirmar a Meta - Cantidad inv√°lida"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"¬°Perfecto! ‚ò∫\\nSigamos entonces.\\n\\n¬øQu√© otro producto te gustar√≠a agregar a tu pedido?\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        1856
      ],
      "id": "968e4d24-4f8b-47ff-992b-cc0414f380ff",
      "name": "Enviar mensaje Volver",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -368,
        1664
      ],
      "id": "3326c655-e1d2-491f-8fea-f448c38fc049",
      "name": "Register Analytics - message_sent - Volver"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -368,
        2032
      ],
      "id": "b0cb60a7-5ced-4ac4-ae45-18cc98f03d6c",
      "name": "Confirmar a Meta Payment1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.from }}"
            },
            {
              "name": "state",
              "value": "awaiting.product"
            },
            {
              "name": "data",
              "value": "={\n  \"order_id\": {{ $json.sessionData.current_order.order_id }},\n  \"total\": {{ $json.sessionData.current_order.total }},\n  \"pending_payment\": true,\n  \"expected_confirmation\": \"payment_confirmation\",\n  \"tipo_venta\": \"mayor\"\n}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        2032
      ],
      "id": "e79723e0-dcb8-4bdf-a728-dd30eac97a0f",
      "name": "Guardar estado - awaiting_product"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"Entendido üëç\\nHe cancelado tu compra por ahora.\\n\\nSi m√°s adelante deseas volver a comprar, solo dimer *hola* ‚ò∫\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        2512
      ],
      "id": "0a10105e-c47c-46c4-bd47-0f0396bbece4",
      "name": "Enviar mensaje Cancelar",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -368,
        2608
      ],
      "id": "36e35ecf-19dc-459e-bbb7-fcda3988e58a",
      "name": "Register Analytics - message_sent - Cancelar"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -368,
        2416
      ],
      "id": "9f211b13-14a9-46ed-a80e-81f2b05181da",
      "name": "Confirmar a Meta Cancelar"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.from }}"
            },
            {
              "name": "state",
              "value": "idle"
            },
            {
              "name": "data",
              "value": "={\n  \"tipo_venta\": \"mayor\"\n}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        2688
      ],
      "id": "1371b371-99cd-433f-a516-5cad1909e626",
      "name": "Guardar estado - idle"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:awaiting_payment_confirmation"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -368,
        2800
      ],
      "id": "e0fca0cd-14bc-40c8-b3e0-73512dbf0d91",
      "name": "Register Analytics - session_state_changed - idle"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:awaiting.product"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -368,
        2224
      ],
      "id": "cb6ea5f7-ff80-4c18-99fa-d372489c4b30",
      "name": "Register Analytics - session_state_changed - awaiting_product2"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ========================================\n//     EXTRACTOR DE TERMINO DE PRODUCTO\n// ========================================\n\nconst input = $input.item.json;\nconst texto = input.texto_normalizado || \"\";\n\n// Filtra palabras\nconst stopwords = [\n  \"quiero\", \"comprar\", \"compra\", \"agregar\", \"otro\", \"otra\",\n  \"seguir\", \"productos\", \"productos\",\n  \"me\", \"gustaria\", \"deseo\", \"un\", \"una\", \"unos\", \"unas\",\n  \"por\", \"favor\", \"para\", \"el\", \"la\", \"los\", \"las\",\n  \"busco\", \"ver\", \"mostrar\", \"catalogo\"\n];\n\n// Limpia\nlet palabras = texto\n  .split(\" \")\n  .map(p => p.trim())\n  .filter(p => p.length > 2)\n  .filter(p => !stopwords.includes(p));\n\nlet terminoBusqueda;\nif (palabras.length === 0) {\n  terminoBusqueda = \"productos\";\n} else {\n  terminoBusqueda = palabras.slice(0, 4).join(\" \");\n}\n\nconst terminoValido = \n  terminoBusqueda &&\n  terminoBusqueda.length >= 3 &&\n  ![\"comprar\", \"producto\", \"productos\", \"catalogo\"].includes(terminoBusqueda);\n\nreturn {\n  json: {\n    ...input,\n    terminoBusqueda: terminoValido ? terminoBusqueda : null,\n    requiere_producto: !terminoValido\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1024,
        4496
      ],
      "id": "363e03a0-d499-4a42-91e8-0fca698f0994",
      "name": "Extraer producto"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ff6eb374-4434-4839-af34-be29ec10bb1a",
              "leftValue": "={{ $json.action }}",
              "rightValue": "create_order",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -432,
        -2736
      ],
      "id": "3f7827de-3340-4df6-9499-88a375ef273c",
      "name": "¬øCreamos orden?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/orders/{{ $json.order_id }}/items",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"product_id\": {{ $json.product_id }},\n  \"quantity\": {{ $json.quantity }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -160,
        -2720
      ],
      "id": "2ad58a05-4ecc-4cf4-9509-41b763403def",
      "name": "POST Agregar Item"
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_API_URL }}/api/orders/{{ $json.order_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        336,
        -2096
      ],
      "id": "c958bd04-d416-4dbc-8cdb-570e83e3986f",
      "name": "GET Orden"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ================================\n// Construir mensaje resumen orden\n// ================================\n\nconst order = $json.data;\n\n// Validaci√≥n defensiva\nif (!order || !Array.isArray(order.items)) {\n  return {\n    json: {\n      messaging_product: \"whatsapp\",\n      to: $json.data?.client_phone || $json.from,\n      type: \"text\",\n      text: {\n        preview_url: false,\n        body: \"‚ö†Ô∏è No pude generar el resumen de tu pedido. Intenta nuevamente.\"\n      }\n    }\n  };\n}\n\nconst shortOrderId = order.id.replace(/-/g, '').slice(-8).toUpperCase();\n\n// Construimos el resumen\nlet message = `¬°Excelente! üòÅ He agregado el producto a tu pedido.\\n\\n`;\nmessage += `üìù *Resumen de tu orden*\\n`;\nmessage += `üÜî Orden: #${shortOrderId}\\n\\n`;\n\norder.items.forEach((item, index) => {\n  message += `${index + 1}. ${item.product_name} ‚Äî Cantidad: ${item.quantity} ‚Äî Total: $${item.total}\\n`;\n});\n\nmessage += `\\nüí∞ *Total del pedido:* $${order.total}\\n\\n`;\nmessage += `¬øDeseas seguir comprando o prefieres proceder al pago?\\n\\n`;\nmessage += `- Escribe *seguir comprando*\\n`;\nmessage += `- O escribe *pagar ahora*`;\nmessage += `üí° _Guarda tu n√∫mero de orden: #${shortOrderId}_`;\n\n// Retornamos JSON listo para WhatsApp\nreturn {\n  json: {\n    messaging_product: \"whatsapp\",\n    to: order.client_phone,\n    type: \"text\",\n    text: {\n      preview_url: false,\n      body: message\n    },\n    order_id: order.id,\n    short_order_id: shortOrderId\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        -2192
      ],
      "id": "366e57cb-ad8d-4bfc-8986-fe49620b9d91",
      "name": "Preparar payload"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "messaging_product",
              "value": "={{ $json.messaging_product }}"
            },
            {
              "name": "to",
              "value": "={{ $json.to }}"
            },
            {
              "name": "type",
              "value": "={{ $json.type }}"
            },
            {
              "name": "text",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        784,
        -2192
      ],
      "id": "4fb9b139-bbb7-4a58-8ab8-975c9d324057",
      "name": "Enviar mensaje Producto Agregado a orden",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1008,
        -2384
      ],
      "id": "3353a7ac-2e52-4c90-ae2b-d0ce4e216083",
      "name": "Register Analytics - message_sent - Producto agregado a orden"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1008,
        -1984
      ],
      "id": "37e7f8e2-4678-4c7d-abba-58e10faae360",
      "name": "Confirmar a Meta - Producto Agregado a orden"
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_API_URL }}/api/orders/{{ $json.data.id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        96,
        -2784
      ],
      "id": "2d046b98-fc75-4442-b574-ee00164c51dc",
      "name": "GET Orden1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        784,
        -1984
      ],
      "id": "f8b7da6f-c87e-4a91-9d97-64416cc0743f",
      "name": "Guardar estado - awaiting_next_action1"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Recibimos el array de productos\nconst products = typeof $json.data.products === \"string\"\n  ? JSON.parse($json.data.products)\n  : $json.data.products;\n\n// Redondeamos\nfunction roundToTwo(num) {\n  return Math.round((num + Number.EPSILON) * 100) / 100;\n}\n\nfunction formatPrice(price) {\n  const rounded = roundToTwo(parseFloat(price || 0));\n  return rounded.toLocaleString('es-CO', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2\n  });\n}\n\n// Construimos mensaje\nlet message = `Encontr√© *${products.length}* productos relacionados:\\n\\n`;\n\nproducts.forEach((p, i) => {\n  const priceRounded = roundToTwo(parseFloat(p.precio || 0));\n  message += `${i + 1}. *${p.nombre}* ‚Äî $${formatPrice(priceRounded)}\\n`;\n});\n\nmessage += `\\nüìå Env√≠a *el n√∫mero del producto* para seleccionarlo.`;\n\n// Retornamos JSON v√°lido (no array)\nreturn {\n  json: {\n    messaging_product: \"whatsapp\",\n    to: $json.user_phone,\n    type: \"text\",\n    text: {\n      preview_url: false,\n      body: message\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        4992
      ],
      "id": "496559a7-204c-4a2b-95eb-43e77685d5c9",
      "name": "Generar payload Productos"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "return {\n  json: {\n    user_phone: $json.data.client_phone,\n    state: \"awaiting.payment\",\n    data: {\n      order_id: $json.data.id,\n      total: $json.data.total,\n      payment_status: $json.data.payment_status,\n      items: $json.data.items,\n      needsPayment: true,\n      timestamp: new Date().toISOString(),\n      tipo_venta: \"mayor\"\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        -1984
      ],
      "id": "dd008d2f-074f-496b-8330-ad461016b63b",
      "name": "Preparar Datos"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.sub_intencion }}",
                    "rightValue": "horario",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "3b872869-6c5e-4099-b86f-4342d27a7ef6"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Horario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e5ab85fb-2fcc-4ff5-8b23-9b3f8bd33754",
                    "leftValue": "={{ $json.sub_intencion }}",
                    "rightValue": "envio",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Env√≠o"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "534dea71-2409-4eb1-9c26-9bef97cf3931",
                    "leftValue": "={{ $json.sub_intencion }}",
                    "rightValue": "pagos",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Pagos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a072ed18-12c7-4ede-bbd1-b221d64146ff",
                    "leftValue": "={{ $json.sub_intencion }}",
                    "rightValue": "ubicacion",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ubicacion"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "40dbf775-6d04-4e95-ac59-1152ffd7d197",
                    "leftValue": "={{ $json.otros }}",
                    "rightValue": "Otros",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Otros"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -816,
        400
      ],
      "id": "09fb395f-adb7-441b-981f-e19f99377624",
      "name": "SubIntencion"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"¬°Claro! üòä Te cuento nuestros horarios de atenci√≥n:\\n\\nüìÖ *Lunes a Viernes*:\\n‚è∞ 8:00 a. m. - 7:30 p. m.\\n\\nüìÖ *Domingos*:\\n‚è∞ 9:00 a. m. - 3:00 p. m.\\n\\nCuando quieras continuamos con tu pedido üëå\\nüëâ Escr√≠beme *s√≠* para seguir\\nüëâ O *no* si deseas cancelar\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        80
      ],
      "id": "2e9cfd33-5426-4277-86bb-505c447c4a27",
      "name": "Enviar mensaje Horario",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -352,
        80
      ],
      "id": "efbdc0c1-9eb6-4ce9-a91b-df396b7c8d9f",
      "name": "Confirmar a Meta Horario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"üöö _Informaci√≥n sobre nuestros env√≠os_:\\n\\nüìç *Env√≠os locales (misma ciudad)*:\\n- Se realizan con domiciliario\\n- Pueden ser contra entrega ‚úÖ\\n\\nüöõ *Env√≠os a otras ciudades (v√≠a terminal)*:\\n- Deben pagarse por adelantado\\n- ‚ùå No son contra entrega\\n- Algunos clientes pueden usar cr√©dito interno, si ya lo tienen aprobado\\n\\n‚è≥ _El tiempo de entrega depende del destino_.\\n\\n¬øDeseas continuar con tu pedido o necesitas ayuda con algo m√°s? ‚ò∫\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        272
      ],
      "id": "454aaad0-fd99-4090-baf9-acd254fca509",
      "name": "Enviar mensaje Env√≠o",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -352,
        272
      ],
      "id": "66638031-580b-442c-a610-424cab93de45",
      "name": "Confirmar a Meta Env√≠o"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"üí≥ *Nuestros m√©todos de pago son*:\\n\\nüè¶ *Transferencia a cuenta Bancolombia*\\nü§ù *Cr√©dito interno* (solo para clientes previamente aprobados)\\n\\nSi deseas pagar o continuar comprando, dime c√≥mo te gustar√≠a seguir ‚ò∫\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        448
      ],
      "id": "7ea6a389-95bc-451c-9847-d12b04f67970",
      "name": "Enviar mensaje Pagos",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -352,
        448
      ],
      "id": "65b7002f-ff91-4f14-9b71-5583e6673820",
      "name": "Confirmar a Meta Pagos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"üìç *Nuestra ubicaci√≥n*\\n\\nPuedes visitarnos en el siguiente punto:\\n\\nüëâ https://www.google.com/maps?q=8.758735656738281,-75.88396453857422&z=17&hl=es\\n\\nSi prefieres, tambi√©n podemos ayudarte con env√≠o a domicilio üöö\\n\\nCuando gustes, dime:\\nüëâ *s√≠* para continuar con la compra\\nüëâ *no* para cancelar\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        640
      ],
      "id": "4bd65eb9-5cf9-4061-83a9-35acaf43b2d1",
      "name": "Enviar mensaje Ubicaci√≥n",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -352,
        640
      ],
      "id": "7558a74c-d73b-43f6-b211-ccbc34abbc2c",
      "name": "Confirmar a Meta Ubicaci√≥n"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"ü§î ¬°Buena pregunta!\\n\\nCon gusto puedo ayudarte con informaci√≥n sobre:\\n- Horarios\\n- Env√≠os\\n- M√©todos de pago\\n- Ubicaci√≥n\\n- O continuar con tu compra\\n\\nSolo dime qu√© necesitas y seguimos ‚ò∫\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        864
      ],
      "id": "16d6856c-30ea-44ba-b860-ef33eb4d062a",
      "name": "Enviar mensaje Otros",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -352,
        864
      ],
      "id": "742b05ea-9de4-4a54-ba3b-b5350f0550fe",
      "name": "Confirmar a Meta Otros"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"¬øQu√© producto est√°s buscando? ‚ò∫\\nPuedes escribir el nombre o modelo.\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        4480
      ],
      "id": "77226a28-2b99-440b-9e11-6da0d0541b33",
      "name": "Enviar mensaje Requiere Producto",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -352,
        4592
      ],
      "id": "d618938e-6697-41e4-a605-1797d810193d",
      "name": "Confirmar a Meta Requiere producto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -352,
        4384
      ],
      "id": "c370b8d2-a138-4aee-8033-3a8c03741f6c",
      "name": "Register Analytics - message_sent - Requiere producto"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f7f48be6-eba3-42c9-9614-c243a1240b5c",
              "leftValue": "={{ $json.requiere_producto }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -816,
        4496
      ],
      "id": "1f31c25b-650a-4d9a-b84e-422ef43ce8c2",
      "name": "¬øRequiere producto?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -352,
        4192
      ],
      "id": "8a52c752-7c3a-4e48-a22e-4f47683016b2",
      "name": "Guardar estado - awaiting_product1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:awaiting.product"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -96,
        4192
      ],
      "id": "d433f888-dd8c-4c5b-8170-618514f67a87",
      "name": "Register Analytics - change_state - awaiting.product"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "return {\n  json: {\n    user_phone: $json.from,\n    state: \"awaiting.product\",\n    data: {\n      order_id: $json.sessionData?.current_order?.order_id ?? null,\n      tipo_venta: \"mayor\"\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        4192
      ],
      "id": "bc2d40c1-b37d-4d18-a8cb-3fb526ea353b",
      "name": "Preparar consulta - Necesita producto"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo_venta || $json.sessionData.tipo_venta || $json.sessionData.current_selection.tipo_venta }}",
                    "rightValue": "mayor",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "0ee68a70-6bf5-4acc-baf0-832dd21ae5ac"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Mayor"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "4bd4b52a-4519-4f7a-83f4-b75178ba2219",
                    "leftValue": "={{ $json.tipo_venta || $json.sessionData.tipo_venta || $json.sessionData.current_selection.tipo_venta }}",
                    "rightValue": "detal",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Detal"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -2048,
        6096
      ],
      "id": "359e8fc4-8209-4979-a722-3bbb41b19001",
      "name": "¬øTipo de venta?"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "return {\n  json: {\n    from: $input.item.json.from,\n    userName: $input.item.json.userName,\n    numero_detal: \"+573122083554\"\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1072,
        7952
      ],
      "id": "9ed3aed9-db37-4edc-ae29-f361e37264fb",
      "name": "Preparar mensaje DETAL"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"Hola {{ $json.userName }} üëã\\n\\nVeo que est√°s interesado en compra al *DETAL*.\\n\\nPara ventas por unidad o pocas cantidades, por favor comunicate con nuestro equipo de ventas al detal:\\n\\nüì± *{{ $json.numero_detal }}*\\n\\nEllos te atender√°n con gusto. ‚ò∫\\n\\nSi deseas compra *POR MAYOR* (12+ unidades), con gusto puedo ayudarte aqu√≠ mismo.\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -800,
        7952
      ],
      "id": "6a02bc80-da5b-4dc6-b0ca-ca597fdcd961",
      "name": "Enviar mensaje DETAL",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -544,
        7952
      ],
      "id": "5825880a-600f-4a92-be49-2951aef7c405",
      "name": "Confirmar a Meta - Mensaje DETAL"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.awaiting_quantity.reason }}",
                    "rightValue": "InvalidNumber",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "37773a04-9fc4-455f-84ef-3efe2c63570a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "N√∫mero Inv√°lido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "6896051a-0b27-4bc6-9161-222a4aec306d",
                    "leftValue": "={{ $json.awaiting_quantity.reason }}",
                    "rightValue": "BelowMinimumForMayor",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "M√≠nimo MAYOR"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "3dbefe28-ee4d-4795-91b9-b1b44022e83d",
                    "leftValue": "={{ $json.awaiting_quantity.reason }}",
                    "rightValue": "InsufficientStock",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Sin Stock"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -608,
        -1984
      ],
      "id": "6d4b1880-ca9b-42c5-9f47-604d6c7dc1b5",
      "name": "Tipo de Error"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"‚ö† Para compra *AL MAYOR* necesitas un m√≠nimo de *12 unidades*.\\n\\nSolicitaste: {{ $json.awaiting_quantity.minQuantityValidation.requestedQuantity }} unidades\\n\\nüì¶ *Opciones disponibles:*\\n\\n1Ô∏è‚É£ Ajustar a 12+ unidades para compra al mayor\\n2Ô∏è‚É£ Cambiar a compra *AL DETAL* (menores cantidades)\\n\\n¬øQue prefieres?\\n- Escribe un *n√∫mero >= 12* para continuar\\n- 0 escribe *detal* para cambiar a venta al detal\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -352,
        -1968
      ],
      "id": "7ed942e4-fe11-4395-a215-048596807a3e",
      "name": "Mensaje M√≠nimo MAYOR",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -160,
        -1856
      ],
      "id": "5a637edd-bf5d-4c05-baa0-58a875a1d46c",
      "name": "Confirmar a Meta - M√≠nimo mayor"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -160,
        -2080
      ],
      "id": "fa81baf6-e0e3-4d46-91d7-a26dddcb302f",
      "name": "Register Analytics - message_sent - M√≠nimo mayor"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"‚ö† Lo siento, solo tenemos *{{ $json.awaiting_quantity.stockValidation.available }} unidades* disponibles de este producto.\\n\\nSolicitaste: {{ $json.awaiting_quantity.stockValidation.requestedQuantity }} unidades\\n\\nüì¶ *¬øQu√© deseas hacer?*\\n\\n- Escribe *{{ $json.awaiting_quantity.stockValidation.available }}* para ordenar todo el stock disponible\\n- Escribe otra cantidad menor\\n- O escribe *cancelar* para elegir otro producto\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -352,
        -1552
      ],
      "id": "a632b7c7-a8a7-4ed6-874c-111bc3f616f1",
      "name": "Mensaje Sin Stock",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -160,
        -1664
      ],
      "id": "3e740f67-1906-4829-9c6a-a995eb8d4080",
      "name": "Register Analytics - message_sent - Sin Stock"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -160,
        -1456
      ],
      "id": "16951512-111f-4342-bfd4-4b930c6b88dc",
      "name": "Confirmar a Meta - Sin stock"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        -3952,
        5888
      ],
      "id": "25088a6c-8458-43e1-9929-60787180ce1d",
      "name": "Error Handler"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ============================================\n// ==== PROCESADOR CENTRALIZADO DE ERRORES ====\n// ============================================\n\nconst input = $input.item.json;\n\nconst error = input.error || {};\nconst errorMessage = error.message || input.message || 'Error desconocido';\nconst errorDescription = error.description || '';\nconst errorStack = error.stack || '';\n\nconst executionId = $execution.id || 'unknown';\nconst workflowId = $workflow.id || 'unknown';\n\nlet userPhone = 'unknown';\nlet userName = 'unknown';\n\nif (input.from) {\n  userPhone = input.from;\n}\nif (input.userName) {\n  userName = input.userName;\n}\n\nif (error.context) {\n  userPhone = error.context.from || userPhone;\n  userName = error.context.userName || userName;\n}\n\nif (input.execution?.data?.resultData) {\n try {\n  const runData = input.execution.data.resultData.runData;\n   for (const nodeName in runData) {\n     const nodeData = runData[nodeName];\n     if (nodeData && nodeData[0]?.data?.main?.[0]?.[0]?.json) {\n       const json = nodeData[0].data.main[0][0].json;\n       if (json.from) userPhone = json.from;\n       if (json.userName) userName = json.userName;\n       break;\n     }\n   }\n } catch (e) {\n   \n }\n}\n// Extrae informaci√≥n del error\nconst errorInfo = {\n  timestamp: new Date().toISOString(),\n  execution_id: executionId,\n  workflow_id: workflowId,\n  error_message: errorMessage,\n  error_description: errorDescription,\n  stack_trace: errorStack,\n  user_phone: userPhone,\n  user_name: userName,\n  error_type: 'backend_error',\n  severity: 'high',\n  context: {\n    workflow_name: $workflow.name || 'unknown',\n    node_name: error.node?.name || 'unknown'\n  }\n};\n\nlet errorCategory = 'unknown';\nlet userMessage = 'Lo siento, ocurri√≥ un error inesperado. Por favor intenta nuevamente.';\nlet shouldRetry = false;\n\nconst errorMsg = errorMessage.toLowerCase();\n\nif (errorMsg.includes('econnrefused') || errorMsg.includes('etimedout')) {\n  errorCategory = 'connection_error';\n  userMessage = 'üîå No pude conectarme con nuestros servidores.\\n\\nPor favor intenta nuevamente en unos momentos.';\n  shouldRetry = true;\n} else if (errorMsg.includes('404')) {\n  errorCategory = 'not_found';\n  userMessage = 'üîç No encontr√© lo que buscas.\\n\\nPor favor intenta con otra b√∫squeda o escribe *ayuda*.';\n} else if (errorMsg.includes('500') || errorMsg.includes('502') || errorMsg.includes('503')) {\n  errorCategory = 'server_error';\n  userMessage = '‚ö†Ô∏è Nuestros servidores est√°n teniendo problemas.\\n\\nEstamos trabajando en solucionarlo. Intenta nuevamente en 5 minutos.';\n  shouldRetry = true;\n} else if (errorMsg.includes('401') || errorMsg.includes('403')) {\n  errorCategory = 'auth_error';\n  userMessage = 'üîê Error de autenticaci√≥n.\\n\\nPor favor contacta con soporte.';\n} else if (errorMsg.includes('timeout')) {\n  errorCategory = 'timeout';\n  userMessage = '‚è±Ô∏è La solicitud tard√≥ demasiado.\\n\\nPor favor intenta nuevamente.';\n  shouldRetry = true;\n} else if (errorMsg.includes('cannot read properties') || errorMsg.includes('undefined')) {\n  errorCategory = 'data_error';\n  userMessage = 'üìä Error procesando los datos.\\n\\nPor favor intenta nuevamente o escribe *ayuda*.';\n}\n\nreturn {\n  json: {\n    ...errorInfo,\n    error_category: errorCategory,\n    user_message: userMessage,\n    should_retry: shouldRetry,\n    retry_count: 0\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3760,
        5888
      ],
      "id": "26e227b4-6127-4b2f-bfcb-c0d023b12e6f",
      "name": "Procesar Error"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/logs",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"log_type\": \"error\",\n  \"severity\": \"{{ $json.severity }}\",\n  \"error_category\": \"{{ $json.error_category }}\",\n  \"error_message\": \"{{ $json.error_message }}\",\n  \"node_name\": \"{{ $json.node_name }}\",\n  \"user_phone\": \"{{ $json.user_phone }}\",\n  \"timestamp\": \"{{ $json.timestamp }}\",\n  \"execution_id\": \"{{ $json.execution_id }}\",\n  \"stack_trace\": \"{{ $json.stack_trace }}\",\n  \"raw_data\": {{ $json }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3504,
        5888
      ],
      "id": "aaf00fa5-16ce-4874-bcf3-b25b3fddc91f",
      "name": "Log Error",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.user_phone }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"{{ $json.user_message }}\\n\\nüÜî C√≥digo de error: {{ $json.execution_id.substring(0, 8) }}\\n\\nSi el problema persiste, por favor contacta a soporte con este c√≥digo.\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3504,
        6080
      ],
      "id": "30e2e39b-2764-4b86-bb5e-5cfd3615a619",
      "name": "Notificar Error al Usuario",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "9a70bba2-a7e3-4970-b243-8dc12acb0fc8",
              "leftValue": "={{ $json.error }}",
              "rightValue": "undefined",
              "operator": {
                "type": "object",
                "operation": "notExists",
                "singleValue": true
              }
            },
            {
              "id": "f6fb4b53-25c9-49f7-b335-90891ceb59ba",
              "leftValue": "={{ $json.products }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        128,
        5152
      ],
      "id": "38a1abba-0d07-420c-8de3-216d2e780e44",
      "name": "¬øBackend respondi√≥?"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ====================================\n// ==== PREPARAR ERROR DE B√öSQUEDA ====\n// ====================================\n\n// Accede al item actual\nconst currentItem = $input.item.json;\n\n// Extrae datos de ususario\nconst from = currentItem.from || currentItem.user_phone || 'unknown';\nconst userName = currentItem.userName || currentItem.clientName || 'Cliente';\nconst searchTerm = currentItem.searchTerm || currentItem.terminoBusqueda || '';\n\n// Informaci√≥n del error\nconst error = currentItem.error || {};\nconst errorMessage = error.message || 'Error desconocido';\n\nreturn {\n  json: {\n    from: from,\n    userName: userName,\n    searchTerm: searchTerm,\n    error_type: 'search_failed',\n    user_message: `üîç No pude buscar productos en este momento.\\n\\n${searchTerm ? `Buscabas: \"${searchTerm}\"\\n\\n` : ''}¬øPodr√≠as intentar nuevamente o describir mejor lo que buscas?`,\n    original_error: {\n      message: errorMessage,\n      timestamp: new Date().toISOString()\n    },\n    sessionData: currentItem.sessionData || {},\n    sessionState: currentItem.sessionState || 'idle'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        384,
        5456
      ],
      "id": "4338a275-42e8-4b98-af36-b502fd0c97ec",
      "name": "Preparar Error B√∫squeda"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"{{ $json.user_message }}\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        624,
        5456
      ],
      "id": "103d6f63-3e80-4218-9849-3ab88173a77d",
      "name": "Mensaje Error B√∫squeda",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        880,
        5344
      ],
      "id": "67a49cdc-c459-4135-b845-92d56682593c",
      "name": "Confirmar a Meta - Error B√∫squeda"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        880,
        5568
      ],
      "id": "affd7e74-3742-40a4-90b1-bf42a77ae8af",
      "name": "Register Analytics - message_sent - Error B√∫squeda"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "0203ba9b-a97d-45f3-a751-2bd998f4bf79",
              "leftValue": "={{ $json.data }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "74542084-39c3-4364-a3f2-3bc59a786116",
              "leftValue": "={{ $json.data.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        96,
        -3040
      ],
      "id": "b9a7b7ab-092c-475f-a197-eb2152cff0a2",
      "name": "¬øOrden creada exitosamente?"
    },
    {
      "parameters": {
        "jsCode": "const from = $input.first().json.from;\nconst userName = $input.first().json.userName;\n\nreturn {\n  json: {\n    messaging_product: \"whatsapp\",\n    to: from,\n    type: \"text\",\n    text: {\n      preview_url: false,\n      body: `Lo siento ${userName} üòî\\n\\nNo pude procesar tu pedido en este momento.\\n\\n¬øPodr√≠as intentar nuevamente?\\n\\nSi el problema persiste, escribe *soporte* para hablar con un agente.`\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        -2496
      ],
      "id": "d0675ac7-d99f-4cd6-975f-938564cb6384",
      "name": "Error Crear Orden"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        528,
        -2496
      ],
      "id": "6bfa226e-3192-425a-bb3a-74b63a873929",
      "name": "Enviar mensaje Error Orden",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        784,
        -2592
      ],
      "id": "b517da9a-9bc3-49bb-a5e2-484214ae6feb",
      "name": "Register Analytics - message_sent - Error Orden"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        784,
        -2384
      ],
      "id": "9f3336b5-5774-4601-8edf-7115b258fc73",
      "name": "Confirmar a Meta - Error orden"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "0203ba9b-a97d-45f3-a751-2bd998f4bf79",
              "leftValue": "={{ $json.data }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            },
            {
              "id": "74542084-39c3-4364-a3f2-3bc59a786116",
              "leftValue": "={{ $json.data.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        112,
        -1904
      ],
      "id": "86f4f6b6-1246-451f-a3fa-63ef5464630f",
      "name": "¬øItem agregado exitosamente?"
    },
    {
      "parameters": {
        "jsCode": "const from = $input.first().json.from;\nconst userName = $input.first().json.userName;\n\nreturn {\n  json: {\n    messaging_product: \"whatsapp\",\n    to: from,\n    type: \"text\",\n    text: {\n      preview_url: false,\n      body: `Lo siento ${userName} üòî\\n\\nNo pude procesar tu pedido en este momento.\\n\\n¬øPodr√≠as intentar nuevamente?\\n\\nSi el problema persiste, escribe *soporte* para hablar con un agente.`\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        -1680
      ],
      "id": "0dac218d-9d93-4e5f-aa6c-0ad88102c371",
      "name": "Error Agregar Item"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        528,
        -1680
      ],
      "id": "b735b438-0b8e-4364-a85e-0b2aa0c398e3",
      "name": "Enviar mensaje Error Item",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        784,
        -1584
      ],
      "id": "604285e4-b412-4745-896a-045063354ca8",
      "name": "Register Analytics - message_sent - Error Item"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        784,
        -1776
      ],
      "id": "bed9ced4-d5ff-4116-a81c-12859e10d355",
      "name": "Confirmar a Meta - Error Item"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "2e964ee5-9842-4279-84a4-2095dbda2f0e",
              "leftValue": "={{ $json.session }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "88f8afe5-e5ec-4ff0-8ca3-4d52465a8e5b",
              "leftValue": "={{ $json.data || $json.session.data }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -3056,
        6096
      ],
      "id": "4d1246b6-0805-4d1f-9408-21ebfbd4b916",
      "name": "¬øSesi√≥n encontrada?"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "return {\n  json: {\n    session: {\n      state: \"idle\",\n      data: {\n        tipo_venta: \"mayor\"\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2816,
        6304
      ],
      "id": "7d2ca34f-9b3a-44ff-a2c9-3764a47a4782",
      "name": "Sesi√≥n por Defecto"
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_API_URL }}/api/orders/user/{{ $json.from }}",
        "options": {
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1072,
        6272
      ],
      "id": "ad88473f-7240-4cde-adb7-c437664f3d52",
      "name": "Obtener √ìrdenes Usuario",
      "retryOnFail": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "cb9a357e-88bd-4db1-a232-6b5c2c709d67",
              "leftValue": "={{ $json.data }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "c425d43c-890f-4b74-8345-feff4363d4c0",
              "leftValue": "={{ $json.data }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "6a10f18d-9794-4a93-a7ba-4d6c224aaa58",
              "leftValue": "={{ $json.data.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -608,
        6576
      ],
      "id": "e85fa3fd-aa32-4a32-b766-5c53be138730",
      "name": "¬øTiene √≥rdenes?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"üîç No encontr√© √≥rdenes registradas con tu n√∫mero.\\n\\n¬øDeseas realizar una nueva compra?\\n\\nüëâ Escribe *comprar* para ver nuestros productos\\nüëâ O escribe *ayuda* si necesitas asistencia\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -352,
        6800
      ],
      "id": "36e96e0e-a2c0-497d-b901-cf065a650af7",
      "name": "Mensaje Sin √ìrdenes",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const input = $input.item.json;\n\nconst orders = input.data || [];\nconst from = input.from;\nconst userName = input.userName || \"Cliente\";\n\nif (!Array.isArray(orders) || orders.length === 0) {\n  return {\n    json: {\n      error: true,\n      message: \"No se encontraron √≥rdenes\",\n      from,\n      userName\n    }\n  };\n}\n\nconst sortedOrders = orders.sort((a, b) => {\n  return new Date(b.created_at) - new Date(a.created_at);\n});\n\nconst statusMap = {\n  pending: \"‚è≥ Pendiente\",\n  processing: \"üì¶ En proceso\",\n  completed: \"‚úÖ Completada\",\n  cancelled: \"‚ùå Cancelada\",\n  shipped: \"üöö Enviada\"\n};\n\nconst paymentStatusMap = {\n  pending: \"‚è≥ Pendiente de pago\",\n  paid: \"‚úÖ Pagado\",\n  failed: \"‚ùå Pago fallido\",\n  refunded: \"üîÅ Reembolsado\"\n};\n\nlet message = `üìù *Tus √≥rdenes recientes:*\\n\\n`;\n\nsortedOrders.slice(0, 5).forEach((order, index) => {\n  const orderDate = new Date(order.created_at).toLocaleDateString('es-CO', {\n    day: '2-digit',\n    month: 'short',\n    year: 'numeric'\n  });\n\n  const status = statusMap[order.status] || order.status;\n  const paymentStatus = paymentStatusMap[order.payment_status] || order.payment_status;\n\n  message += `${index + 1}. *Orden #${order.id}*\\n`;\n  message += `   üìÖ Fecha: ${orderDate}\\n`;\n  message += `   ${status}\\n`;\n  message += `   ${paymentStatus}\\n`;\n  message += `   üí∞ Total: $${order.total?.toLocaleString('es-CO') || 0}\\n`;\n\n  if (order.items && order.items.length > 0) {\n    message += `   üì¶ Productos: ${order.items.length}\\n`;\n  }\n\n  message += `\\n`;\n});\n\nif (sortedOrders.length > 5) {\n  message += `\\n_Mostrando las 5 √≥rdenes m√°s recientes de ${sortedOrders.length} totales_\\n`;\n}\n\nmessage += `\\nüí° *¬øNecesitas ayuda?*\\n`;\nmessage += `- Escribe *comprar* para nueva orden\\n`;\nmessage += `- Escribe *soporte* para asistencia\\n`;\nmessage += `- O dime el n√∫mero de orden para ver detalles\\n`;\n\nreturn {\n  json: {\n    from,\n    userName,\n    message,\n    orders: sortedOrders,\n    total_orders: sortedOrders.length,\n    has_pending: sortedOrders.some(o => o.payment_status === 'pending')\n  }\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -352,
        6368
      ],
      "id": "aa38cf3e-61e1-433a-8a6f-cbf89363041d",
      "name": "Procesar Lista √ìrdenes"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -112,
        6672
      ],
      "id": "0e6a2b2b-7bed-46f1-83a4-247de2ae90a2",
      "name": "Register Analytics - message_sent - Mensaje Sin √ìrdenes"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -112,
        6896
      ],
      "id": "a933a423-210e-4681-9f16-1eb6d8247b3b",
      "name": "Confirmar a Meta - Sin √ìrdenes"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "return {\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $json.from,\n    type: \"text\",\n    text: {\n      preview_url: false,\n      body: $json.message\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -112,
        6368
      ],
      "id": "72806816-2c35-475b-8afa-a694d0f3492f",
      "name": "Formato Mensaje √ìrdenes"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        112,
        6368
      ],
      "id": "e650517b-4037-465d-914f-aa418b04198b",
      "name": "Enviar Mensaje √ìrdenes",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        336,
        6464
      ],
      "id": "f4797e47-bf0f-4ca9-a4ad-7a0598699ee2",
      "name": "Confirmar a Meta - √ìrdenes"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        336,
        6240
      ],
      "id": "589276bf-3306-4eaf-bb78-4e3053ce06c0",
      "name": "Register Analytics - message_sent - √ìrdenes"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ======================================================\n// ==== MENSAJE PARA CUANDO SE CREA LA PRIMERA ORDEN ====\n// ======================================================\n\nconst input = $input.item.json;\nconst orderData = input.data;\n\nconst shortOrderId = orderData.id.slice(-8).toUpperCase();\n\nlet message = `¬°Perfecto ${orderData.client_name}! üëå\\n\\n`;\nmessage += `Tu pedido ha sido registrado exitosamente:\\n\\n`;\nmessage += `üìù *Resumen de tu orden*\\n`;\nmessage += `üÜî Orden: #${shortOrderId}\\n\\n`;\n\nmessage += `* Producto: *${orderData.items[0].product_name}*\\n`;\nmessage += `* Cantidad: *${orderData.items[0].quantity}*\\n`;\nmessage += `* Total: *${orderData.items[0].total.toLocaleString('es-CO')}*\\n\\n`;\n\nmessage += `¬øDeseas seguir comprando o prefieres proceder al pago?\\n\\n`;\nmessage += `- Escribe *seguir comprando*\\n`;\nmessage += `- O escribe *pagar ahora*\\n\\n`;\nmessage += `üí° _Guarda tu n√∫mero de orden: #${shortOrderId}_`;\n\nreturn {\n  json: {\n    messaging_product: \"whatsapp\",\n    to: orderData.client_phone,\n    type: \"text\",\n    text: {\n      preview_url: false,\n      body: message\n    },\n    order_id: orderData.id,\n    short_order_id: shortOrderId\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        -3040
      ],
      "id": "6a1c5f2a-1858-4096-a700-9407ae8106d2",
      "name": "Primera Orden Creada"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ====================================================\n// ==== PREPARAR MENSAJE WHATSAPP + GUARDAR SESI√ìN ====\n// ====================================================\n\nconst prepare = $input.item.json;\nconst orderId = prepare.order_id;\nconst shortOrderId = orderId.slice(-8).toUpperCase();\nconst paymentLink = prepare.payment_link;\nconst reference = prepare.reference;\nconst amount = prepare.amount;\nconst userPhone = prepare.from;\nconst userName = prepare.userName;\nconst metodo_pago = prepare.metodo_pago;\n\n// ==========================\n// ==== Mensaje Whatsapp ====\n// ==========================\nlet message = `¬°Perfecto ${userName}! üí≥\\n\\n`;\nmessage += `Tu orden *#${shortOrderId}* est√° lista para pago.\\n\\n`;\nmessage += `üí∞ *Total:* $${amount.toLocaleString('es-CO')}\\n\\n`;\nmessage += `üëâ *Paga de forma segura aqu√≠:*\\n${paymentLink}\\n\\n`;\nmessage += `üîí Pago protegido con wompi\\n`;\nmessage += `‚è∞ El enlace expira en 24 horas\\n\\n`;\nmessage += `Una vez pagues, recibir√°s confirmaci√≥n autom√°tica ‚úÖ`;\n\nreturn {\n  json: {\n    whatsapp: {\n      messaging_product: \"whatsapp\",\n      to: userPhone,\n      type: \"text\",\n      text: {\n        preview_url: true,\n        body: message\n      }\n    },\n    \n    session: {\n      user_phone: userPhone,\n      state: \"awaiting.payment_confirmation\",\n      data: {\n        tipo_venta: \"mayor\",\n        current_order: {\n          order_id: orderId,\n          shor_order_id: shortOrderId,\n          reference: reference,\n          amount: amount,\n          payment_link: paymentLink,\n          payment_status: \"pending\",\n          payment_method: metodo_pago\n        }\n      }\n    },\n\n    meta: {\n      order_id: orderId,\n      reference: reference,\n      tipo_venta: \"mayor\",\n      payment_method: metodo_pago\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        1472
      ],
      "id": "60879fcb-6029-4e2a-a1b5-c9db6acfa1f4",
      "name": "Preparar Transacci√≥n Wompi"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "wompi-payment",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3952,
        5680
      ],
      "id": "d2e0205f-f853-4edd-844d-abee51f281d0",
      "name": "Confirmar Pago",
      "webhookId": "567bdbda-fafc-4a56-8b3d-f9199d705f11"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ========================\n// ==== EVENTO DE PAGO ====\n// ========================\n\nconst data = $input.item.json;\n\nconst status = data.body.status;\nconst orderId = data.body.order_id;\nconst amount = data.body.amount;\nconst transactionId = data.body.transaction_id;\nconst phone = data.body.customer_phone;\n\nif (!phone || !status) {\n  throw new Error(\"Datos incompletos para notificaci√≥n\");\n}\n\nlet action = \"\";\nlet message = \"\";\n\nif (status === \"APPROVED\") {\n  action = \"payment_approved\";\n  message = `‚úÖ *Pago confirmado*\\n\\nTu pago de $${amount.toLocaleString('es-CO')} fue exitoso.\\n\\nüì¶ Orden: ${orderId}\\nüìù Transacci√≥n: ${transactionId}\\n\\nGracias por tu compra üôå`;\n} else if (status === \"PENDING\") {\n  action = \"payment_pending\";\n  message = `‚è≥ *Pago en verificaci√≥n*\\n\\nTu pago est√° siendo procesado.\\n\\nüì¶ Orden: ${orderId}`;\n}else if (status === \"DECLINED\" || status === \"ERROR\") {\n  action = \"payment_declined\";\n  message = `‚ùå *Pago rechazado*\\n\\nNo fue posible procesar el pago.\\n\\nüì¶ Orden: ${orderId}\\n\\nEscribe *pagar* para intentar nuevamente.`;\n}\n\nreturn {\n  json: {\n    action,\n    messaging_product: \"whatsapp\",\n    to: phone,\n    type: \"text\",\n    text: {\n      preview_url: false,\n      body: message\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3760,
        5680
      ],
      "id": "52295153-7ab2-4afc-bacd-7d694a2560c8",
      "name": "Validaci√≥n Pago"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "messaging_product",
              "value": "={{ $json.messaging_product }}"
            },
            {
              "name": "to",
              "value": "={{ $json.to }}"
            },
            {
              "name": "type",
              "value": "={{ $json.type }}"
            },
            {
              "name": "text",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3504,
        5680
      ],
      "id": "13b45c78-3f75-4653-b982-7314862f4eb3",
      "name": "Enviar WhatsApp Cloud API",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -3056,
        5680
      ],
      "id": "487fc354-9d71-47d6-8a42-cd65dfed1d40",
      "name": "Confirmar Validaci√≥n Pago"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_received"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3264,
        5680
      ],
      "id": "c3cfa734-524c-4cee-9225-52f69c10db7e",
      "name": "Register Analytics - message_received - Validaci√≥n Pago"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"received\",\n  \"reason\": \"{{ new Date().toISOString() }}\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -3056,
        5488
      ],
      "id": "6ccfe8c3-4f49-4b91-baad-d2b6513e2fe7",
      "name": "Confirmar Validaci√≥n Pago Wompi"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/payments/prepare",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "order_id",
              "value": "={{ $json.order_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        704,
        1472
      ],
      "id": "8c0cf313-9f4b-4551-a663-a3e58acd8355",
      "name": "Generar link de pago",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        944,
        1472
      ],
      "id": "d9b0916f-cfb8-4657-83de-b63f0397fe89",
      "name": "Wompi + Datos"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// =================================================\n// ==== PROCESAR Y VALIDAR DIRECCI√ìN DE ENTREGA ====\n// =================================================\n\nconst input = $input.item.json;\n\nconst texto = (input.texto_normalizado || \"\").trim();\nconst sessionData = input.sessionData || {};\nconst userName = input.userName || \"\";\nconst from = input.from;\n\n// Validaci√≥n b√°sica\nconst textoLimpio = texto\n  .replace(/[\\n\\r\\t]/g, \" \")\n  .replace(/\\s+/g, \" \")\n  .trim();\n\nconst direccionInvalida =\n  !textoLimpio ||\n  textoLimpio.length < 8 ||\n  /^[0-9]+$/.test(textoLimpio) ||\n  /^[^a-zA-Z0-9]+$/.test(textoLimpio);\n\n// Si es inv√°lida\nif (direccionInvalida) {\n  return {\n    json: {\n      intencion: \"direccion_invalida\",\n      sessionState: \"awaiting.delivery_address\",\n      sessionData,\n      from,\n      userName,\n      whatsapp_message: {\n        messaging_product: \"whatsapp\",\n        to: from,\n        type: \"text\",\n        text: {\n          preview_url: false,\n          body: \"‚ö† *Direcci√≥n inv√°lida*\\n\\nPor favor escr√≠beme la *direcci√≥n completa de entrega*.\\n\\nEjemplo:\\nüìç Calle 45 #12-34, Barrio Centro\"\n        }\n      }\n    }\n  };\n}\n\n// Direcci√≥n v√°lida\nsessionData.delivery_address = textoLimpio;\n\n//Mensaje\nconst message = \n  `üìç *Direcci√≥n registrada correctamente*\\n\\n` +\n  `üè† ${textoLimpio}\\n\\n` +\n  `¬øDeseas confirmar? üí≥\\n\\n` +\n  `üëâ Escribe *si* para continuar\\n\\n` +\n  `üëâ O *cambiar* para editar`;\n\nreturn {\n  json: {\n    intencion: \"direccion_guardada\",\n    sessionState: \"awaiting.delivery_address_confirmation\",\n    sessionData,\n    from,\n    userName,\n    whatsapp_message: {\n      messaging_product: \"whatsapp\",\n      to: from,\n      type: \"text\",\n      text: {\n        preview_url: false,\n        body: message\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        8608
      ],
      "id": "a7ed2b25-fa89-4a43-8a58-25e25757fe4e",
      "name": "Procesar Direcci√≥n"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -304,
        8640
      ],
      "id": "e16ce558-bbed-4fc5-8277-7a7543c849b4",
      "name": "Confirmar a Meta - Mensaje Direcci√≥n"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.whatsapp_message }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -544,
        8528
      ],
      "id": "c326a4c4-4786-44d7-a42c-0a7101076e79",
      "name": "Enviar mensaje Direcci√≥n",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -304,
        8448
      ],
      "id": "715c847b-17fe-4a54-bfcc-532c46a309bf",
      "name": "Register Analytics - message_sent - Mensaje Direcci√≥n"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.from }}"
            },
            {
              "name": "state",
              "value": "={{ $json.sessionState }}"
            },
            {
              "name": "data",
              "value": "={{ $json.sessionData }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -544,
        8704
      ],
      "id": "436f8bd3-a57b-4188-8502-04e77684c14d",
      "name": "Guardar estado - Direcci√≥n"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "3c32b01b-e1c5-46de-b09b-13ca53d6ae20",
              "leftValue": "={{ $json.intencion }}",
              "rightValue": "pedir_direccion_entrega",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1072,
        8416
      ],
      "id": "4299ecba-3714-4317-a048-4cd987b17df9",
      "name": "¬øPedimos direcci√≥n?"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const input = $input.item.json;\n\nconst sessionData = input.sessionData;\nconst sessionState = input.sessionState;\n\nconst from = input.from;\n\nreturn {\n  json:{\n    sessionData,\n    sessionState,\n    from,\n    whatsapp_message: {\n      messaging_product: \"whatsapp\",\n      to: from,\n      type: \"text\",\n      text: {\n        preview_url: false,\n        body: \"üìç Para continuar necesito tu direcci√≥n de entrega completa\\n(calle, barrio, ciudad y una referencia si puedes)\"\n      }\n    }\n  }\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        8240
      ],
      "id": "ee4daf18-6eca-44db-85fa-b9ca007eb2c4",
      "name": "Preparar mensaje Pedir Direcci√≥n"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.whatsapp_message }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -544,
        8144
      ],
      "id": "8acbc993-611c-4c41-adfe-a04cc11250e6",
      "name": "Enviar mensaje Pedir Direcci√≥n",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -304,
        8048
      ],
      "id": "8fd0c6b3-20ca-4de6-b3b0-f121bf83e296",
      "name": "Register Analytics - message_sent - Mensaje Pedir Direcci√≥n"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -304,
        8240
      ],
      "id": "18c15403-fe42-40d4-9081-5e2a3f77f72a",
      "name": "Confirmar a Meta - Mensaje Pedir Direcci√≥n"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.from }}"
            },
            {
              "name": "state",
              "value": "={{ $json.sessionState }}"
            },
            {
              "name": "data",
              "value": "={{ $json.sessionData }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -544,
        8336
      ],
      "id": "a76f5af0-c036-4a14-88db-d6d1f453df2b",
      "name": "Guardar estado - Pedir Direcci√≥n"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ==============================================\n// ==== CONFIRMACI√ìN DE DIRECCI√ìN DE ENTREGA ====\n// ==============================================\n\nconst input = $input.item.json;\n\nconst texto = (input.texto_normalizado || \"\").toLowerCase();\nconst sessionData = input.sessionData || {};\nconst userName = input.userName || \"\";\nconst from = input.from;\n\nconst direccion = sessionData.delivery_address || \"\";\n\n// No hay direccion\nif (!direccion) {\n  return {\n    json: {\n      intencion: \"direccion_faltante\",\n      sessionState: \"awaiting.delivery_address\",\n      sessionData,\n      from,\n      userName,\n      whatsapp_message: {\n        messaging_product: \"whatsapp\",\n        to: from,\n        type: \"text\",\n        text: {\n          preview_url: false,\n          body: \"‚ö† No tengo registrada tu direcci√≥n de entrega.\\n\\nPor favor enviamela nuevamente üìç\"\n        }\n      }\n    }\n  };\n}\n\n// Palabras clave\nconst confirmar = [\"si\", \"s√≠\", \"confirmo\", \"correcta\", \"ok\", \"dale\", \"perfecto\"];\nconst cambiar = [\"cambiar\", \"editar\", \"otra\", \"modificar\", \"no\"];\n\n// Confirma\nif (confirmar.some(w => texto.includes(w))) {\n  return {\n    json: {\n      intencion: \"direccion_confirmada\",\n      sessionState: \"awaiting.payment\",\n      sessionData,\n      from,\n      userName,\n      whatsapp_message: {\n        messaging_product: \"whatsapp\",\n        to: from,\n        type: \"text\",\n        text: {\n          preview_url: false,\n          body: `‚úÖ *Direcci√≥n confirmada*\\n\\nüìç ${direccion}\\n\\nProcedamos con el *pago* üí≥\\n\\nüëâ Escribe *pagar* para continuar`\n        }\n      }\n    }\n  };\n}\n\n// Cambiar\nif (cambiar.some(w => texto.includes(w))) {\n  delete sessionData.delivery_address;\n\n  return {\n    json: {\n      intencion: \"direccion_cambiar\",\n      sessionState: \"awaiting.delivery_address\",\n      sessionData,\n      from,\n      userName,\n      whatsapp_message: {\n        messaging_product: \"whatsapp\",\n        to: from,\n        type: \"text\",\n        text: {\n          preview_url: false,\n          body: \"üñä De acuerdo, enviame la *nueva direcci√≥n de entrega* üìç\\n\\nEjemplo:\\nCalle 45 #12-34, Barrio centro\"\n        }\n      }\n    }\n  };\n}\n\n// Respuesta inv√°lida\nreturn {\n  json: {\n    intencion: \"direccion_confirmacion_invalida\",\n    sessionState: \"awaiting.delivery_address_confirmation\",\n    sessionData,\n    from,\n    userName,\n    whatsapp_message: {\n      messaging_product: \"whatsapp\",\n      to: from,\n      type: \"text\",\n      text: {\n        preview_url: false,\n        body: `üìç Tengo esta direcci√≥n:\\n\\nüè† ${direccion}\\n\\n¬øEs correcta?\\n\\nüëâ Responde *si* para confirmar\\nüëâ O escribe *cambiar* para editarla`\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1072,
        9200
      ],
      "id": "3cda017e-ad95-466d-974c-9eb23c66dada",
      "name": "Confirmar Direcci√≥n"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.whatsapp_message }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -784,
        9008
      ],
      "id": "93554334-07fb-43f1-ad15-70a59d17ab84",
      "name": "Enviar mensaje Confirmar Direcci√≥n",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -544,
        8896
      ],
      "id": "1cf24cd2-0475-47a6-a8a4-0a729beac50c",
      "name": "Register Analytics - message_sent - Mensaje Confirmar Direcci√≥n"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -544,
        9088
      ],
      "id": "00661a91-2737-4808-b0d9-86d110d638fb",
      "name": "Confirmar a Meta - Mensaje Confirmar Direcci√≥n"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.from }}"
            },
            {
              "name": "state",
              "value": "={{ $json.sessionState }}"
            },
            {
              "name": "data",
              "value": "={{ $json.sessionData }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -784,
        9200
      ],
      "id": "851e5ffa-8028-4fc6-9630-587a201e7bbc",
      "name": "Guardar estado - Confirmar Direcci√≥n"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "cdd2b832-5330-4893-ab44-4b4aa6dfbbc4",
              "leftValue": "={{ $json.intencion }}",
              "rightValue": "direccion_confirmada",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -784,
        9392
      ],
      "id": "94705824-3710-4e03-9775-17f4372adc5b",
      "name": "¬øConfirm√≥ direcci√≥n?"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ $env.BACKEND_API_URL }}/api/orders/{{ $json.sessionData.current_order.order_id }}/delivery-address",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"delivery_address\": \"{{ $json.sessionData.delivery_address }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -544,
        9392
      ],
      "id": "c005aea6-af39-41c3-be89-809cd56e8726",
      "name": "PATCH Actualizar Orden"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "53b211ce-edcc-4258-84b3-68caeea279a9",
              "leftValue": "={{ $json.action }}",
              "rightValue": "payment_approved",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -3504,
        5488
      ],
      "id": "85d2ba16-feb1-4f4e-96e9-01c72c196493",
      "name": "¬øActualizamos estado?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.to }}"
            },
            {
              "name": "state",
              "value": "=idle"
            },
            {
              "name": "data",
              "value": "={}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3264,
        5488
      ],
      "id": "51244f08-2b9e-4f15-8b71-0b0618da7a3b",
      "name": "Aprobado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.whatsapp_message }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        1472
      ],
      "id": "fad2392d-7058-4f11-a502-0a5c3028a45c",
      "name": "Enviar mensaje Awaiting Payment",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "payment_pending"
            },
            {
              "name": "value",
              "value": "={{ $json.session.data.current_order.amount }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -592,
        1664
      ],
      "id": "641a1da1-a2ef-4d3f-b7a7-5d418d8c1901",
      "name": "Register Analytics - payment_pending - Awaiting Payment"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -368,
        1472
      ],
      "id": "389415ee-e394-4546-9b6f-3b05ab203e77",
      "name": "Confirmar a Meta Awaiting Payment"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -816,
        6576
      ],
      "id": "f66df825-ae7c-440c-bb2e-5cde63fe0d47",
      "name": "Ordenes + Datos"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// =======================================\n// ==== PREPARAR MENSAJE DE DESPEDIDA ====\n// =======================================\n\nconst input = $input.item.json;\nconst userName = input.userName || \"Cliente\";\nconst from = input.from;\nconst sessionData = input.sessionData || {};\n\nconst hasPendingOrder = sessionData.current_order && sessionData.current_order.payment_status === 'pending';\n\nlet message = `¬°Hasta pronto ${userName}! üëã\\n\\n`;\n\nif (hasPendingOrder) {\n  const shortOrderId = sessionData.current_order.order_id?.slice(-8).toUpperCase();\n  message += `Recuerda que tienes una orden pendiente:\\n`;\n  message += `üì¶ Orden: #${shortOrderId}\\n`;\n  message += `üí∞ Total: $${sessionData.current_order.total?.toLocaleString('es-CO') || 0}\\n\\n`;\n  message += `Cuando quieras continuar, solo escribe *hola* üòä\\n\\n`;\n}\n\nmessage += `Gracias por contactarnos. Estamos aqu√≠ cuando nos necesites.\\n\\n`;\nmessage += `‚ú® *¬øQu√© puedo hacer?*\\n`;\nmessage += `- Escribe *hola* para volver\\n`;\nmessage += `- Escribe *comprar* para ver productos\\n`;\nmessage += `- Escribe *soporte* si necesitas ayuda\\n\\n`;\nmessage += `¬°Que tengas un excelente d√≠a! üåü`;\n\nreturn {\n  json: {\n    from,\n    userName,\n    sessionData,\n    hasPendingOrder,\n    whatsapp_message: {\n      messaging_product: \"whatsapp\",\n      to: from,\n      type: \"text\",\n      text: {\n        preview_url: false,\n        body: message\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1072,
        7280
      ],
      "id": "be73e87c-2a47-49a2-b6cc-bc3841d7fb1e",
      "name": "Preparar mensaje Despedida"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.whatsapp_message }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -800,
        7280
      ],
      "id": "66daee81-19ce-40e4-a33f-092a1fdbbba3",
      "name": "Enviar mensaje Despedida",
      "credentials": {
        "httpHeaderAuth": {
          "id": "igjMQtjr4IzmMT0c",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"received\"\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -544,
        7088
      ],
      "id": "368c31c7-dd64-4da4-adaa-584e8910d7b5",
      "name": "Confirmar a Meta - Despedida"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "message_sent"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -544,
        7280
      ],
      "id": "0e51cab3-b92a-4680-a751-e6e40a761859",
      "name": "Register Analytics - message_sent - Despedida"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.contacts[0].wa_id }}"
            },
            {
              "name": "state",
              "value": "idle"
            },
            {
              "name": "data",
              "value": "={\n  \"tipo_venta\": \"mayor\",\n  \"last_interaction\": \"despedida\",\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -544,
        7472
      ],
      "id": "53365928-7e6a-46fc-b81c-8867b132cc96",
      "name": "Guardar estado - idle (Despedida)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/analytics",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "session_state_changed:idle"
            },
            {
              "name": "value",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -272,
        7472
      ],
      "id": "5a8df1ff-3682-4f40-9ceb-db8317cc10c7",
      "name": "Register Analytics - session_state_changed - idle (Despedida)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_API_URL }}/api/chat-sessions",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.to_number }}"
            },
            {
              "name": "state",
              "value": "awaiting.support"
            },
            {
              "name": "data",
              "value": "={\n  \"tipo_venta\": \"mayor\",\n  \"last_interaction\": \"soporte\",\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        384,
        5808
      ],
      "id": "5ca8a98f-9e65-4ff0-ba87-39ffdd81e878",
      "name": "Guardar estado - awaiting.support"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Register Analytics - message_received",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Log Incoming Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "¬øEs mensaje v√°lido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs mensaje v√°lido?": {
      "main": [
        [
          {
            "node": "Obtener estado de conversaci√≥n",
            "type": "main",
            "index": 0
          },
          {
            "node": "Estado / Datos",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Mensaje no valido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rutear por intenci√≥n": {
      "main": [
        [
          {
            "node": "Validar cantidad",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¬øConfirm√≥?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Metodo Pago",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "N√∫mero seleccionado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extraer producto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Soporte",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Saludo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener √ìrdenes Usuario",
            "type": "main",
            "index": 0
          },
          {
            "node": "Ordenes + Datos",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Preparar mensaje Despedida",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Preparar mensaje DETAL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¬øPedimos direcci√≥n?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Direcci√≥n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Otro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Otro": {
      "main": [
        [
          {
            "node": "Unir Respuestas",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Soporte": {
      "main": [
        [
          {
            "node": "Unir Respuestas",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Saludo": {
      "main": [
        [
          {
            "node": "Unir Respuestas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unir Respuestas": {
      "main": [
        [
          {
            "node": "Preparar payload WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar WhatsApp": {
      "main": [
        [
          {
            "node": "Confirmar a Meta",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent -",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasificar por palabras clave": {
      "main": [
        [
          {
            "node": "Log Clasification message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          },
          {
            "node": "Producto + Datos",
            "type": "main",
            "index": 0
          },
          {
            "node": "No Producto + Datos",
            "type": "main",
            "index": 1
          },
          {
            "node": "¬øTipo de venta?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar payload WhatsApp": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Log Message Recived",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guardar estado - awaiting.support",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar producto": {
      "main": [
        [
          {
            "node": "¬øBackend respondi√≥?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar consulta del producto": {
      "main": [
        [
          {
            "node": "¬øNecesita informaci√≥n?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øNecesita informaci√≥n?": {
      "main": [
        [
          {
            "node": "Preparar mensaje para pedir info",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Buscar producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar mensaje para pedir info": {
      "main": [
        [
          {
            "node": "Pedir info",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar JSON - Esperando Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pedir info": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - Pedir info",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Pedir info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar JSON - Esperando Producto": {
      "main": [
        [
          {
            "node": "Guardar estado - Esperando producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener estado de conversaci√≥n": {
      "main": [
        [
          {
            "node": "¬øExist√≠a sesi√≥n?",
            "type": "main",
            "index": 0
          },
          {
            "node": "¬øSesi√≥n encontrada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estado / Datos": {
      "main": [
        [
          {
            "node": "Clasificar por palabras clave",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar cantidad": {
      "main": [
        [
          {
            "node": "¬øEs valida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Encontr√≥": {
      "main": [
        [
          {
            "node": "Flatten Product Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Encontr√©": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - Encontr√©",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Encontr√©",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - product_view - Encontr√© < 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Producto + Datos": {
      "main": [
        [
          {
            "node": "Enviar mensaje Encontr√©",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guardar estado - Confirmar producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Flatten Product Result": {
      "main": [
        [
          {
            "node": "Producto + Datos",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Producto confirmado": {
      "main": [
        [
          {
            "node": "Actualizar sesi√≥n",
            "type": "main",
            "index": 0
          },
          {
            "node": "Enviar mensaje Pedir cantidad",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - checkout_started - Pedir cantidad1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rechaz√≥": {
      "main": [
        [
          {
            "node": "Actualizar sesi√≥n - awaiting.product",
            "type": "main",
            "index": 0
          },
          {
            "node": "Enviar mensaje Consultar producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Pedir cantidad": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - Pedir cantidad",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Pedir cantidad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Consultar producto": {
      "main": [
        [
          {
            "node": "Confirmar a Meta Consultar producto",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Consultar producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje No encontr√©": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - No Encontr√©",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - No encontr√©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "M√∫ltiples productos encontrados": {
      "main": [
        [
          {
            "node": "Generar payload Productos",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guardar estado - Seleccionar Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Encontr√© >1": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - Encontr√© > 1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Encontr√© > 1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - product_view - Encontr√© > 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "N√∫mero seleccionado": {
      "main": [
        [
          {
            "node": "¬øEs v√°lido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs v√°lido?": {
      "main": [
        [
          {
            "node": "Seleccionar producto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar mensaje N√∫mero Invalido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Seleccionar producto": {
      "main": [
        [
          {
            "node": "Enviar mensaje Producto Seleccionado",
            "type": "main",
            "index": 0
          },
          {
            "node": "Actualizar sesi√≥n - Awaiting Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Producto Seleccionado": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - Confirmar Producto",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Producto seleccionado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje N√∫mero Invalido": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - N√∫mero Inv√°lido",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Numero inv√°lido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Producto + Datos": {
      "main": [
        [
          {
            "node": "Tipo de respuesta1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øConfirm√≥?": {
      "main": [
        [
          {
            "node": "Producto confirmado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rechaz√≥",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SubIntencion",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar mensaje Mensaje inv√°lido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs valida?": {
      "main": [
        [
          {
            "node": "Guardar cantidad",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tipo de Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar cantidad": {
      "main": [
        [
          {
            "node": "¬øCreamos orden?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST Crear Orden": {
      "main": [
        [
          {
            "node": "¬øOrden creada exitosamente?",
            "type": "main",
            "index": 0
          },
          {
            "node": "GET Orden1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Producto Agregado": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - Producto Agregado",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Producto agregado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Datos + Producto agregado": {
      "main": [
        [
          {
            "node": "Guardar estado - awaiting_next_action",
            "type": "main",
            "index": 0
          },
          {
            "node": "Primera Orden Creada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Metodo Pago": {
      "main": [
        [
          {
            "node": "awaiting_payment_actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "awaiting_payment_actions": {
      "main": [
        [
          {
            "node": "Enviar mensaje Awaiting Payment",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - payment_pending - Awaiting Payment",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar mensaje Volver",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guardar estado - awaiting_product",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar mensaje Cancelar",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guardar estado - idle",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "send_whatsapp_invalid_payment_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Payment": {
      "main": [
        [
          {
            "node": "Confirmar a Meta Payment",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Payment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send_whatsapp_invalid_payment_response": {
      "main": [
        [
          {
            "node": "Confirmar a Meta Invalid Payment",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Payment Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øExist√≠a sesi√≥n?": {
      "main": [
        [
          {
            "node": "Register Analytics - session_started",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar estado - awaiting_next_action": {
      "main": [
        [
          {
            "node": "Register Analytics - session_state_changed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar estado - awaiting_payment_confirmation": {
      "main": [
        [
          {
            "node": "Register Analytics - session_state_changed - awaiting_payment_confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar sesi√≥n - Awaiting Confirmation": {
      "main": [
        [
          {
            "node": "Register Analytics - session_state_changed - awaiting_confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar estado - Esperando producto": {
      "main": [
        [
          {
            "node": "Register Analytics - session_state_changed - awaiting_product",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar estado - Seleccionar Producto": {
      "main": [
        [
          {
            "node": "Register Analytics - session_state_changed - awaiting_selection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar estado - Confirmar producto": {
      "main": [
        [
          {
            "node": "Register Analytics - session_state_changed - awaiting_confirmation1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar sesi√≥n": {
      "main": [
        [
          {
            "node": "Register Analytics - session_state_changed - awaiting_quantity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de respuesta": {
      "main": [
        [
          {
            "node": "No Producto + Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de respuesta1": {
      "main": [
        [
          {
            "node": "Encontr√≥",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "M√∫ltiples productos encontrados",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar mensaje No encontr√©",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar JSON - Esperando Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar sesi√≥n - awaiting.product": {
      "main": [
        [
          {
            "node": "Register Analytics - session_state_changed - Idle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Mensaje inv√°lido": {
      "main": [
        [
          {
            "node": "Register Analytics - message_sent - mensaje inv√°lido",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar a Meta Mensaje inv√°lido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Cantidad inv√°lida": {
      "main": [
        [
          {
            "node": "Register Analytics - message_sent - Cantidad inv√°lida",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar a Meta - Cantidad inv√°lida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Volver": {
      "main": [
        [
          {
            "node": "Register Analytics - message_sent - Volver",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar a Meta Payment1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar estado - awaiting_product": {
      "main": [
        [
          {
            "node": "Register Analytics - session_state_changed - awaiting_product2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Cancelar": {
      "main": [
        [
          {
            "node": "Register Analytics - message_sent - Cancelar",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar a Meta Cancelar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar estado - idle": {
      "main": [
        [
          {
            "node": "Register Analytics - session_state_changed - idle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer producto": {
      "main": [
        [
          {
            "node": "¬øRequiere producto?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCreamos orden?": {
      "main": [
        [
          {
            "node": "POST Crear Orden",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "POST Agregar Item",
            "type": "main",
            "index": 0
          },
          {
            "node": "GET Orden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET Orden": {
      "main": [
        [
          {
            "node": "Preparar payload",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar payload": {
      "main": [
        [
          {
            "node": "Enviar mensaje Producto Agregado a orden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Producto Agregado a orden": {
      "main": [
        [
          {
            "node": "Register Analytics - message_sent - Producto agregado a orden",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar a Meta - Producto Agregado a orden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET Orden1": {
      "main": [
        [
          {
            "node": "Datos + Producto agregado",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Generar payload Productos": {
      "main": [
        [
          {
            "node": "Enviar mensaje Encontr√© >1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos": {
      "main": [
        [
          {
            "node": "Guardar estado - awaiting_next_action1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Horario": {
      "main": [
        [
          {
            "node": "Confirmar a Meta Horario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SubIntencion": {
      "main": [
        [
          {
            "node": "Enviar mensaje Horario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar mensaje Env√≠o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar mensaje Pagos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar mensaje Ubicaci√≥n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar mensaje Otros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Env√≠o": {
      "main": [
        [
          {
            "node": "Confirmar a Meta Env√≠o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Pagos": {
      "main": [
        [
          {
            "node": "Confirmar a Meta Pagos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Ubicaci√≥n": {
      "main": [
        [
          {
            "node": "Confirmar a Meta Ubicaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Otros": {
      "main": [
        [
          {
            "node": "Confirmar a Meta Otros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Requiere Producto": {
      "main": [
        [
          {
            "node": "Confirmar a Meta Requiere producto",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Requiere producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øRequiere producto?": {
      "main": [
        [
          {
            "node": "Enviar mensaje Requiere Producto",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar consulta - Necesita producto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar consulta del producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar estado - awaiting_product1": {
      "main": [
        [
          {
            "node": "Register Analytics - change_state - awaiting.product",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar consulta - Necesita producto": {
      "main": [
        [
          {
            "node": "Guardar estado - awaiting_product1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øTipo de venta?": {
      "main": [
        [
          {
            "node": "Rutear por intenci√≥n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar mensaje DETAL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar mensaje DETAL": {
      "main": [
        [
          {
            "node": "Enviar mensaje DETAL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje DETAL": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - Mensaje DETAL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de Error": {
      "main": [
        [
          {
            "node": "Enviar mensaje Cantidad inv√°lida",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje M√≠nimo MAYOR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje Sin Stock",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje M√≠nimo MAYOR": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - M√≠nimo mayor",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - M√≠nimo mayor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Sin Stock": {
      "main": [
        [
          {
            "node": "Register Analytics - message_sent - Sin Stock",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar a Meta - Sin stock",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Handler": {
      "main": [
        [
          {
            "node": "Procesar Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Error": {
      "main": [
        [
          {
            "node": "Log Error",
            "type": "main",
            "index": 0
          },
          {
            "node": "Notificar Error al Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Error": {
      "main": [
        []
      ]
    },
    "¬øBackend respondi√≥?": {
      "main": [
        [
          {
            "node": "Tipo de respuesta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Error B√∫squeda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Error B√∫squeda": {
      "main": [
        [
          {
            "node": "Mensaje Error B√∫squeda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Error B√∫squeda": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - Error B√∫squeda",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Error B√∫squeda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øOrden creada exitosamente?": {
      "main": [
        [
          {
            "node": "Datos + Producto agregado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Crear Orden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Crear Orden": {
      "main": [
        [
          {
            "node": "Enviar mensaje Error Orden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Error Orden": {
      "main": [
        [
          {
            "node": "Register Analytics - message_sent - Error Orden",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar a Meta - Error orden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST Agregar Item": {
      "main": [
        [
          {
            "node": "¬øItem agregado exitosamente?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øItem agregado exitosamente?": {
      "main": [
        [
          {
            "node": "GET Orden",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Agregar Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Agregar Item": {
      "main": [
        [
          {
            "node": "Enviar mensaje Error Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Error Item": {
      "main": [
        [
          {
            "node": "Register Analytics - message_sent - Error Item",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar a Meta - Error Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øSesi√≥n encontrada?": {
      "main": [
        [
          {
            "node": "Estado / Datos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sesi√≥n por Defecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sesi√≥n por Defecto": {
      "main": [
        [
          {
            "node": "Estado / Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener √ìrdenes Usuario": {
      "main": [
        [
          {
            "node": "Ordenes + Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øTiene √≥rdenes?": {
      "main": [
        [
          {
            "node": "Procesar Lista √ìrdenes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje Sin √ìrdenes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Sin √ìrdenes": {
      "main": [
        [
          {
            "node": "Register Analytics - message_sent - Mensaje Sin √ìrdenes",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar a Meta - Sin √ìrdenes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Lista √ìrdenes": {
      "main": [
        [
          {
            "node": "Formato Mensaje √ìrdenes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formato Mensaje √ìrdenes": {
      "main": [
        [
          {
            "node": "Enviar Mensaje √ìrdenes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Mensaje √ìrdenes": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - √ìrdenes",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - √ìrdenes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Primera Orden Creada": {
      "main": [
        [
          {
            "node": "Enviar mensaje Producto Agregado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Transacci√≥n Wompi": {
      "main": [
        [
          {
            "node": "Crear Pago",
            "type": "main",
            "index": 0
          },
          {
            "node": "Enviar mensaje Payment",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guardar estado - awaiting_payment_confirmation",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - payment_pending - Payment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Pago": {
      "main": [
        [
          {
            "node": "Validaci√≥n Pago",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validaci√≥n Pago": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp Cloud API",
            "type": "main",
            "index": 0
          },
          {
            "node": "¬øActualizamos estado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar WhatsApp Cloud API": {
      "main": [
        [
          {
            "node": "Register Analytics - message_received - Validaci√≥n Pago",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Register Analytics - message_received - Validaci√≥n Pago": {
      "main": [
        [
          {
            "node": "Confirmar Validaci√≥n Pago",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar Validaci√≥n Pago Wompi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar link de pago": {
      "main": [
        [
          {
            "node": "Wompi + Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wompi + Datos": {
      "main": [
        [
          {
            "node": "Preparar Transacci√≥n Wompi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Register Analytics - message_received": {
      "main": [
        []
      ]
    },
    "Procesar Direcci√≥n": {
      "main": [
        [
          {
            "node": "Enviar mensaje Direcci√≥n",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guardar estado - Direcci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Direcci√≥n": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - Mensaje Direcci√≥n",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Mensaje Direcci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPedimos direcci√≥n?": {
      "main": [
        [
          {
            "node": "Preparar mensaje Pedir Direcci√≥n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar Direcci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar mensaje Pedir Direcci√≥n": {
      "main": [
        [
          {
            "node": "Enviar mensaje Pedir Direcci√≥n",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guardar estado - Pedir Direcci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Pedir Direcci√≥n": {
      "main": [
        [
          {
            "node": "Register Analytics - message_sent - Mensaje Pedir Direcci√≥n",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar a Meta - Mensaje Pedir Direcci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Direcci√≥n": {
      "main": [
        [
          {
            "node": "Enviar mensaje Confirmar Direcci√≥n",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guardar estado - Confirmar Direcci√≥n",
            "type": "main",
            "index": 0
          },
          {
            "node": "¬øConfirm√≥ direcci√≥n?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Confirmar Direcci√≥n": {
      "main": [
        [
          {
            "node": "Register Analytics - message_sent - Mensaje Confirmar Direcci√≥n",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar a Meta - Mensaje Confirmar Direcci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øConfirm√≥ direcci√≥n?": {
      "main": [
        [
          {
            "node": "PATCH Actualizar Orden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øActualizamos estado?": {
      "main": [
        [
          {
            "node": "Aprobado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Awaiting Payment": {
      "main": [
        [
          {
            "node": "Confirmar a Meta Awaiting Payment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ordenes + Datos": {
      "main": [
        [
          {
            "node": "¬øTiene √≥rdenes?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar mensaje Despedida": {
      "main": [
        [
          {
            "node": "Enviar mensaje Despedida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensaje Despedida": {
      "main": [
        [
          {
            "node": "Confirmar a Meta - Despedida",
            "type": "main",
            "index": 0
          },
          {
            "node": "Register Analytics - message_sent - Despedida",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guardar estado - idle (Despedida)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar estado - idle (Despedida)": {
      "main": [
        [
          {
            "node": "Register Analytics - session_state_changed - idle (Despedida)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "d23c9e0f-cf2f-4b5d-8b13-db5ed0a83011",
  "meta": {
    "instanceId": "6d60290014d829adb12e27dad5521925691d82e5f36ae0254ccbd0ce9e0525e0"
  },
  "id": "zLRCMKyRixvfXRSf",
  "tags": []
}